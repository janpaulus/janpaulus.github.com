<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>youBot Driver: ethercatmain.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='../../open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='../../closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='../../closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="../../dir_8cc86e4513fd21e92bbc0f7893630384.html">soem</a>&nbsp;&raquo;&nbsp;<a class="el" href="../../dir_1086005baf707edfe0b93a7ee9dc1255.html">src</a>
  </div>
</div>
<div class="contents">
<h1>ethercatmain.c</h1><a href="../../d3/d6b/ethercatmain_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Simple Open EtherCAT Master Library </span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * File    : ethercatmain.c</span>
<a name="l00005"></a>00005 <span class="comment"> * Version : 1.2.5</span>
<a name="l00006"></a>00006 <span class="comment"> * Date    : 09-04-2011</span>
<a name="l00007"></a>00007 <span class="comment"> * Copyright (C) 2005-2011 Speciaal Machinefabriek Ketels v.o.f.</span>
<a name="l00008"></a>00008 <span class="comment"> * Copyright (C) 2005-2011 Arthur Ketels</span>
<a name="l00009"></a>00009 <span class="comment"> * Copyright (C) 2008-2009 TU/e Technische Universiteit Eindhoven </span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * SOEM is free software; you can redistribute it and/or modify it under</span>
<a name="l00012"></a>00012 <span class="comment"> * the terms of the GNU General Public License version 2 as published by the Free</span>
<a name="l00013"></a>00013 <span class="comment"> * Software Foundation.</span>
<a name="l00014"></a>00014 <span class="comment"> *</span>
<a name="l00015"></a>00015 <span class="comment"> * SOEM is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<a name="l00016"></a>00016 <span class="comment"> * WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<a name="l00017"></a>00017 <span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
<a name="l00018"></a>00018 <span class="comment"> * for more details.</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * As a special exception, if other files instantiate templates or use macros</span>
<a name="l00021"></a>00021 <span class="comment"> * or inline functions from this file, or you compile this file and link it</span>
<a name="l00022"></a>00022 <span class="comment"> * with other works to produce a work based on this file, this file does not</span>
<a name="l00023"></a>00023 <span class="comment"> * by itself cause the resulting work to be covered by the GNU General Public</span>
<a name="l00024"></a>00024 <span class="comment"> * License. However the source code for this file must still be made available</span>
<a name="l00025"></a>00025 <span class="comment"> * in accordance with section (3) of the GNU General Public License.</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * This exception does not invalidate any other reasons why a work based on</span>
<a name="l00028"></a>00028 <span class="comment"> * this file might be covered by the GNU General Public License.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * The EtherCAT Technology, the trade name and logo “EtherCAT” are the intellectual</span>
<a name="l00031"></a>00031 <span class="comment"> * property of, and protected by Beckhoff Automation GmbH. You can use SOEM for</span>
<a name="l00032"></a>00032 <span class="comment"> * the sole purpose of creating, using and/or selling or otherwise distributing</span>
<a name="l00033"></a>00033 <span class="comment"> * an EtherCAT network master provided that an EtherCAT Master License is obtained</span>
<a name="l00034"></a>00034 <span class="comment"> * from Beckhoff Automation GmbH.</span>
<a name="l00035"></a>00035 <span class="comment"> *</span>
<a name="l00036"></a>00036 <span class="comment"> * In case you did not receive a copy of the EtherCAT Master License along with</span>
<a name="l00037"></a>00037 <span class="comment"> * SOEM write to Beckhoff Automation GmbH, Eiserstraße 5, D-33415 Verl, Germany</span>
<a name="l00038"></a>00038 <span class="comment"> * (www.beckhoff.com).</span>
<a name="l00039"></a>00039 <span class="comment"> */</span>
<a name="l00040"></a>00040 <span class="comment"></span>
<a name="l00041"></a>00041 <span class="comment">/**</span>
<a name="l00042"></a>00042 <span class="comment"> * \file</span>
<a name="l00043"></a>00043 <span class="comment"> * \brief</span>
<a name="l00044"></a>00044 <span class="comment"> * Main EtherCAT functions.</span>
<a name="l00045"></a>00045 <span class="comment"> *</span>
<a name="l00046"></a>00046 <span class="comment"> * Initialisation, state set and read, mailbox primitives, EEPROM primitives,</span>
<a name="l00047"></a>00047 <span class="comment"> * SII reading and processdata exchange.</span>
<a name="l00048"></a>00048 <span class="comment"> *</span>
<a name="l00049"></a>00049 <span class="comment"> * Defines ec_slave[]. All slave information is put in this structure. </span>
<a name="l00050"></a>00050 <span class="comment"> * Needed for most user interaction with slaves.</span>
<a name="l00051"></a>00051 <span class="comment"> */</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/dbb/ethercattype_8h.html" title="General typedefs and defines for EtherCAT.">ethercattype.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d46/nicdrv_8h.html" title="Headerfile for nicdrv.c.">nicdrv.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dd2/ethercatbase_8h.html" title="Headerfile for ethercatbase.c.">ethercatbase.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d38/ethercatmain_8h.html" title="Headerfile for ethercatmain.c.">ethercatmain.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="comment"></span>
<a name="l00063"></a>00063 <span class="comment">/** delay in us for eeprom ready loop */</span>
<a name="l00064"></a><a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d">00064</a> <span class="preprocessor">#define EC_LOCALDELAY   200</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00066"></a>00066 <span class="comment">/** stack structure to store segmented LRD/LWR/LRW constructs */</span>
<a name="l00067"></a><a class="code" href="../../d7/da6/structec__idxstack_t.html">00067</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00068"></a>00068 {
<a name="l00069"></a><a class="code" href="../../d7/da6/structec__idxstack_t.html#a3205168dc4671aca28a039b9770765c0">00069</a>   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>   pushed;
<a name="l00070"></a><a class="code" href="../../d7/da6/structec__idxstack_t.html#ad1b9826ad7afec8cf7ac4889cf91480f">00070</a>   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>   pulled;
<a name="l00071"></a><a class="code" href="../../d7/da6/structec__idxstack_t.html#a6ce8a93c3e54aabe5f17f2b22600971e">00071</a>   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>   idx[<a class="code" href="../../d2/dbb/ethercattype_8h.html#a43211ae8db6b984d0afed5c870e2a0bf" title="number of frame buffers per channel (tx, rx1 rx2)">EC_MAXBUF</a>];
<a name="l00072"></a><a class="code" href="../../d7/da6/structec__idxstack_t.html#a20b056ab6fddf6c39d1ea8b8e98f17e8">00072</a>   <span class="keywordtype">void</span>  *data[<a class="code" href="../../d2/dbb/ethercattype_8h.html#a43211ae8db6b984d0afed5c870e2a0bf" title="number of frame buffers per channel (tx, rx1 rx2)">EC_MAXBUF</a>];
<a name="l00073"></a><a class="code" href="../../d7/da6/structec__idxstack_t.html#a342286482b3f5d0978ebd81ce33a0583">00073</a>   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a>  length[<a class="code" href="../../d2/dbb/ethercattype_8h.html#a43211ae8db6b984d0afed5c870e2a0bf" title="number of frame buffers per channel (tx, rx1 rx2)">EC_MAXBUF</a>];
<a name="l00074"></a>00074 } <a class="code" href="../../d7/da6/structec__idxstack_t.html" title="stack structure to store segmented LRD/LWR/LRW constructs">ec_idxstackT</a>;
<a name="l00075"></a>00075 <span class="comment"></span>
<a name="l00076"></a>00076 <span class="comment">/** record for ethercat eeprom communications */</span>
<a name="l00077"></a>00077 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">PACKED</a>
<a name="l00078"></a>00078 {
<a name="l00079"></a><a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#a5307909961ad21d67d4c6580552f5bbe">00079</a>     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a>  <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#a5307909961ad21d67d4c6580552f5bbe">comm</a>;
<a name="l00080"></a><a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#acf380647fbea1a0daaa9c8759927c966">00080</a>     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a>  <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#acf380647fbea1a0daaa9c8759927c966">addr</a>;
<a name="l00081"></a><a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#af0b786050ce4a35f23b36ec4124bcb58">00081</a>     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a>  <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#af0b786050ce4a35f23b36ec4124bcb58">d2</a>;
<a name="l00082"></a>00082 } <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">ec_eepromt</a>;
<a name="l00083"></a>00083 <span class="comment"></span>
<a name="l00084"></a>00084 <span class="comment">/** ringbuf for error storage */</span>
<a name="l00085"></a><a class="code" href="../../d5/d6d/structec__eringt.html">00085</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>
<a name="l00086"></a>00086 {
<a name="l00087"></a><a class="code" href="../../d5/d6d/structec__eringt.html#ae0d9dceea7a1e17863b5239b1eba99f2">00087</a>     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a259fa4834387bd68627ddf37bb3ebdb9">int16</a>       head;
<a name="l00088"></a><a class="code" href="../../d5/d6d/structec__eringt.html#a2f1776c95c00e0c5e7f7a42c8b7f0739">00088</a>     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a259fa4834387bd68627ddf37bb3ebdb9">int16</a>       tail;
<a name="l00089"></a><a class="code" href="../../d5/d6d/structec__eringt.html#ac2fa33a0e5676d7c7a08800d944ae5be">00089</a>     <a class="code" href="../../d3/d91/structec__errort.html" title="Struct to retrieve errors.">ec_errort</a>   Error[<a class="code" href="../../d8/d38/ethercatmain_8h.html#a4a6ec3fa9da8c50cc22b36e6266dd75f">EC_MAXELIST</a> + 1];
<a name="l00090"></a>00090 } <a class="code" href="../../d5/d6d/structec__eringt.html" title="ringbuf for error storage">ec_eringt</a>;
<a name="l00091"></a>00091 <span class="comment"></span>
<a name="l00092"></a>00092 <span class="comment">/** emergency request structure */</span>
<a name="l00093"></a><a class="code" href="../../d2/d06/structec__emcyt.html">00093</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00094"></a>00094 {
<a name="l00095"></a><a class="code" href="../../d2/d06/structec__emcyt.html#a29ea284c3771b429ddd1302cc11129ae">00095</a>     <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">ec_mbxheadert</a>   MbxHeader;
<a name="l00096"></a><a class="code" href="../../d2/d06/structec__emcyt.html#a7b87e688c6d62fefcf017b9ec2a6accd">00096</a>     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a>          CANOpen;
<a name="l00097"></a><a class="code" href="../../d2/d06/structec__emcyt.html#a742f3913a82568da85221e7f098ca4aa">00097</a>     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a>          ErrorCode;
<a name="l00098"></a><a class="code" href="../../d2/d06/structec__emcyt.html#a2d90b9efa5ad3153672d1a9b6264eb25">00098</a>     <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>           ErrorReg;
<a name="l00099"></a><a class="code" href="../../d2/d06/structec__emcyt.html#af8d0bfc65a0650b5269153c7ab9c0c7d">00099</a>     <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>           bData;
<a name="l00100"></a><a class="code" href="../../d2/d06/structec__emcyt.html#a1f0207657b22ae784503d61dddb2a02f">00100</a>     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a>          w1,w2;
<a name="l00101"></a>00101 } <a class="code" href="../../d2/d06/structec__emcyt.html" title="emergency request structure">ec_emcyt</a>;
<a name="l00102"></a>00102 <span class="comment"></span>
<a name="l00103"></a>00103 <span class="comment">/** Main slave data array.</span>
<a name="l00104"></a>00104 <span class="comment"> *  Each slave found on the network gets its own record.</span>
<a name="l00105"></a>00105 <span class="comment"> *  ec_slave[0] is reserved for the master. Structure gets filled</span>
<a name="l00106"></a>00106 <span class="comment"> *  in by the configuration function ec_config().</span>
<a name="l00107"></a>00107 <span class="comment"> */</span>
<a name="l00108"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#aecfdb60a1628926de0f3cfed483e37fb">00108</a> <a class="code" href="../../da/dff/structec__slavet.html" title="for list of ethercat slaves detected">ec_slavet</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#aecfdb60a1628926de0f3cfed483e37fb" title="Main slave data array.">ec_slave</a>[<a class="code" href="../../d8/d38/ethercatmain_8h.html#aac9d5921632e71c5733e86a26feccf04">EC_MAXSLAVE</a>];<span class="comment"></span>
<a name="l00109"></a>00109 <span class="comment">/** number of slaves found on the network */</span> 
<a name="l00110"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#aa9c784abc9a4ede41d3d8d688b4a7dc5">00110</a> <span class="keywordtype">int</span>     <a class="code" href="../../d3/d6b/ethercatmain_8c.html#aa9c784abc9a4ede41d3d8d688b4a7dc5" title="number of slaves found on the network">ec_slavecount</a>;<span class="comment"></span>
<a name="l00111"></a>00111 <span class="comment">/** slave group structure */</span>
<a name="l00112"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a2bdce50a46e56597354e404a55344934">00112</a> <a class="code" href="../../dd/d43/structec__groupt.html" title="for list of ethercat slave groups">ec_groupt</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a2bdce50a46e56597354e404a55344934" title="slave group structure">ec_group</a>[<a class="code" href="../../d8/d38/ethercatmain_8h.html#a1f13aca133c78710a901be88d513f692">EC_MAXGROUP</a>];
<a name="l00113"></a>00113 <span class="comment"></span>
<a name="l00114"></a>00114 <span class="comment">/** cache for EEPROM read functions */</span>
<a name="l00115"></a>00115 <span class="keyword">static</span> <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>    esibuf[<a class="code" href="../../d2/dbb/ethercattype_8h.html#a6e94d73c1eb1a9ff2aa0a0b3ac09409a" title="size of EEPROM cache buffer">EC_MAXEEPBUF</a>];<span class="comment"></span>
<a name="l00116"></a>00116 <span class="comment">/** bitmap for filled cache buffer bytes */</span>
<a name="l00117"></a>00117 <span class="keyword">static</span> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a>   esimap[<a class="code" href="../../d2/dbb/ethercattype_8h.html#adf65441b6852d17f84eb30430e0f3522" title="size of EEPROM bitmap cache">EC_MAXEEPBITMAP</a>];<span class="comment"></span>
<a name="l00118"></a>00118 <span class="comment">/** current slave for EEPROM cache buffer */</span>
<a name="l00119"></a>00119 <span class="keyword">static</span> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a>   esislave=0;
<a name="l00120"></a>00120 <span class="keyword">static</span> <a class="code" href="../../d5/d6d/structec__eringt.html" title="ringbuf for error storage">ec_eringt</a>  ec_elist;
<a name="l00121"></a>00121 <span class="keyword">static</span> <a class="code" href="../../d7/da6/structec__idxstack_t.html" title="stack structure to store segmented LRD/LWR/LRW constructs">ec_idxstackT</a> ec_idxstack;
<a name="l00122"></a>00122 <span class="comment"></span>
<a name="l00123"></a>00123 <span class="comment">/** Global variable TRUE if error available in error stack */</span>
<a name="l00124"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#ae6ac42aa9d853c4dbd2d07721f467b05">00124</a> <span class="keywordtype">boolean</span>   <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ae6ac42aa9d853c4dbd2d07721f467b05" title="Global variable TRUE if error available in error stack.">EcatError</a> = <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00125"></a>00125 
<a name="l00126"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#aa8af54f31728e900657522c71b0f4fb9">00126</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#aa8af54f31728e900657522c71b0f4fb9">ec_DCtO</a>;
<a name="l00127"></a>00127 <span class="keyword">static</span> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> ec_DCl;
<a name="l00128"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a4774df1c543d7a4941bc96af7d0fd9b8">00128</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a87dc1c46a17e3ee6037afdb6aef76632">int64</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a4774df1c543d7a4941bc96af7d0fd9b8">ec_DCtime</a>;
<a name="l00129"></a>00129 <span class="comment"></span>
<a name="l00130"></a>00130 <span class="comment">/** Pushes an error on the error list.</span>
<a name="l00131"></a>00131 <span class="comment"> *</span>
<a name="l00132"></a>00132 <span class="comment"> * @param[in] Ec     Struct describing the error.</span>
<a name="l00133"></a>00133 <span class="comment"> */</span>
<a name="l00134"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a91e361f3f3615c5ee22eb17def4d1532">00134</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a91e361f3f3615c5ee22eb17def4d1532" title="Pushes an error on the error list.">ec_pusherror</a>(<span class="keyword">const</span> <a class="code" href="../../d3/d91/structec__errort.html" title="Struct to retrieve errors.">ec_errort</a> *Ec)
<a name="l00135"></a>00135 {
<a name="l00136"></a>00136     ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#ac2fa33a0e5676d7c7a08800d944ae5be">Error</a>[ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#ae0d9dceea7a1e17863b5239b1eba99f2">head</a>] = *Ec;
<a name="l00137"></a>00137     ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#ac2fa33a0e5676d7c7a08800d944ae5be">Error</a>[ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#ae0d9dceea7a1e17863b5239b1eba99f2">head</a>].<a class="code" href="../../d3/d91/structec__errort.html#a69713e2dee4c11b81fdac48b6939afe7" title="Signal bit, error set but not read.">Signal</a> = <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00138"></a>00138     ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#ae0d9dceea7a1e17863b5239b1eba99f2">head</a>++;
<a name="l00139"></a>00139     <span class="keywordflow">if</span> (ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#ae0d9dceea7a1e17863b5239b1eba99f2">head</a> &gt; <a class="code" href="../../d8/d38/ethercatmain_8h.html#a4a6ec3fa9da8c50cc22b36e6266dd75f">EC_MAXELIST</a>)
<a name="l00140"></a>00140         ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#ae0d9dceea7a1e17863b5239b1eba99f2">head</a> = 0;
<a name="l00141"></a>00141     <span class="keywordflow">if</span> (ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#ae0d9dceea7a1e17863b5239b1eba99f2">head</a> == ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#a2f1776c95c00e0c5e7f7a42c8b7f0739">tail</a>)
<a name="l00142"></a>00142         ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#a2f1776c95c00e0c5e7f7a42c8b7f0739">tail</a>++;
<a name="l00143"></a>00143     <span class="keywordflow">if</span> (ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#a2f1776c95c00e0c5e7f7a42c8b7f0739">tail</a> &gt; <a class="code" href="../../d8/d38/ethercatmain_8h.html#a4a6ec3fa9da8c50cc22b36e6266dd75f">EC_MAXELIST</a>)
<a name="l00144"></a>00144         ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#a2f1776c95c00e0c5e7f7a42c8b7f0739">tail</a> = 0;
<a name="l00145"></a>00145   <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ae6ac42aa9d853c4dbd2d07721f467b05" title="Global variable TRUE if error available in error stack.">EcatError</a> = <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 <span class="comment"></span>
<a name="l00148"></a>00148 <span class="comment">/** Pops an error from the list.</span>
<a name="l00149"></a>00149 <span class="comment"> *</span>
<a name="l00150"></a>00150 <span class="comment"> * @param[out] Ec = Struct describing the error.</span>
<a name="l00151"></a>00151 <span class="comment"> * @return TRUE if an error was popped.</span>
<a name="l00152"></a>00152 <span class="comment"> */</span>
<a name="l00153"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#ac5e3fbef1307f9df820124075c373fbd">00153</a> <span class="keywordtype">boolean</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ac5e3fbef1307f9df820124075c373fbd" title="Pops an error from the list.">ec_poperror</a>(<a class="code" href="../../d3/d91/structec__errort.html" title="Struct to retrieve errors.">ec_errort</a> *Ec)
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155     <span class="keywordtype">boolean</span> notEmpty = (ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#ae0d9dceea7a1e17863b5239b1eba99f2">head</a> != ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#a2f1776c95c00e0c5e7f7a42c8b7f0739">tail</a>);
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     *Ec = ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#ac2fa33a0e5676d7c7a08800d944ae5be">Error</a>[ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#a2f1776c95c00e0c5e7f7a42c8b7f0739">tail</a>];
<a name="l00158"></a>00158     ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#ac2fa33a0e5676d7c7a08800d944ae5be">Error</a>[ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#a2f1776c95c00e0c5e7f7a42c8b7f0739">tail</a>].<a class="code" href="../../d3/d91/structec__errort.html#a69713e2dee4c11b81fdac48b6939afe7" title="Signal bit, error set but not read.">Signal</a> = <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00159"></a>00159     <span class="keywordflow">if</span> (notEmpty)
<a name="l00160"></a>00160     {
<a name="l00161"></a>00161         ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#a2f1776c95c00e0c5e7f7a42c8b7f0739">tail</a>++;
<a name="l00162"></a>00162         <span class="keywordflow">if</span> (ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#a2f1776c95c00e0c5e7f7a42c8b7f0739">tail</a> &gt; <a class="code" href="../../d8/d38/ethercatmain_8h.html#a4a6ec3fa9da8c50cc22b36e6266dd75f">EC_MAXELIST</a>)
<a name="l00163"></a>00163             ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#a2f1776c95c00e0c5e7f7a42c8b7f0739">tail</a> = 0;
<a name="l00164"></a>00164     }
<a name="l00165"></a>00165   <span class="keywordflow">else</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ae6ac42aa9d853c4dbd2d07721f467b05" title="Global variable TRUE if error available in error stack.">EcatError</a> = <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00166"></a>00166     <span class="keywordflow">return</span> notEmpty;
<a name="l00167"></a>00167 }
<a name="l00168"></a>00168 <span class="comment"></span>
<a name="l00169"></a>00169 <span class="comment">/** Check if error list has entries.</span>
<a name="l00170"></a>00170 <span class="comment"> *</span>
<a name="l00171"></a>00171 <span class="comment"> * @return TRUE if error list contains entries.</span>
<a name="l00172"></a>00172 <span class="comment"> */</span>
<a name="l00173"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a5cf68427133d1d92def6130e4cf9b5a4">00173</a> <span class="keywordtype">boolean</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a5cf68427133d1d92def6130e4cf9b5a4" title="Check if error list has entries.">ec_iserror</a>(<span class="keywordtype">void</span>)
<a name="l00174"></a>00174 {
<a name="l00175"></a>00175   <span class="keywordflow">return</span> (ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#ae0d9dceea7a1e17863b5239b1eba99f2">head</a> != ec_elist.<a class="code" href="../../d5/d6d/structec__eringt.html#a2f1776c95c00e0c5e7f7a42c8b7f0739">tail</a>);
<a name="l00176"></a>00176 }
<a name="l00177"></a>00177 <span class="comment"></span>
<a name="l00178"></a>00178 <span class="comment">/** Report packet error</span>
<a name="l00179"></a>00179 <span class="comment"> *</span>
<a name="l00180"></a>00180 <span class="comment"> * @param[in]  Slave    = Slave number</span>
<a name="l00181"></a>00181 <span class="comment"> * @param[in]  Index    = Index that generated error</span>
<a name="l00182"></a>00182 <span class="comment"> * @param[in]  SubIdx     = Subindex that generated error</span>
<a name="l00183"></a>00183 <span class="comment"> * @param[in]  ErrorCode  = Error code</span>
<a name="l00184"></a>00184 <span class="comment"> */</span>
<a name="l00185"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a430e1266d5c0c1bd4153b660e4fa5298">00185</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a430e1266d5c0c1bd4153b660e4fa5298" title="Report packet error.">ec_packeterror</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> Slave, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> Index, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> SubIdx, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> ErrorCode)
<a name="l00186"></a>00186 {
<a name="l00187"></a>00187     <a class="code" href="../../d3/d91/structec__errort.html" title="Struct to retrieve errors.">ec_errort</a> Ec;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189   gettimeofday(&amp;Ec.<a class="code" href="../../d3/d91/structec__errort.html#a7f0b9956570bf544551d6288519d501c" title="Time at which the error was generated.">Time</a>, 0);
<a name="l00190"></a>00190     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a252e4c13d20d75e0f1cbb7133e02b54e" title="Slave number that generated the error.">Slave</a> = Slave;
<a name="l00191"></a>00191     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a8b5fb38df3f34f4db469708aa81cdaa3" title="CoE SDO index that generated the error.">Index</a> = Index;
<a name="l00192"></a>00192     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a2c0af5d3bb76e00d3449281cbff50d68" title="CoE SDO subindex that generated the error.">SubIdx</a> = SubIdx;
<a name="l00193"></a>00193     <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ae6ac42aa9d853c4dbd2d07721f467b05" title="Global variable TRUE if error available in error stack.">EcatError</a> = <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00194"></a>00194     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a2482ef37892e8f15c33ce398f6fe34d0" title="Type of error.">Etype</a> = <a class="code" href="../../d2/dbb/ethercattype_8h.html#a190c73e51d0d980cd2f88c95c862f0fca94a949dc63eaf551c8fe8dffdc8d9c13">EC_ERR_TYPE_PACKET_ERROR</a>;
<a name="l00195"></a>00195     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a742f3913a82568da85221e7f098ca4aa">ErrorCode</a> = ErrorCode;
<a name="l00196"></a>00196     <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a91e361f3f3615c5ee22eb17def4d1532" title="Pushes an error on the error list.">ec_pusherror</a>(&amp;Ec);
<a name="l00197"></a>00197 }
<a name="l00198"></a>00198 <span class="comment"></span>
<a name="l00199"></a>00199 <span class="comment">/** Report Mailbox Emergency Error</span>
<a name="l00200"></a>00200 <span class="comment"> *</span>
<a name="l00201"></a>00201 <span class="comment"> * @param[in]  Slave    = Slave number</span>
<a name="l00202"></a>00202 <span class="comment"> * @param[in]  ErrorCode    = Following EtherCAT specification</span>
<a name="l00203"></a>00203 <span class="comment"> * @param[in]  ErrorReg</span>
<a name="l00204"></a>00204 <span class="comment"> * @param[in]  b1</span>
<a name="l00205"></a>00205 <span class="comment"> * @param[in]  w1</span>
<a name="l00206"></a>00206 <span class="comment"> * @param[in]  w2</span>
<a name="l00207"></a>00207 <span class="comment"> */</span>
<a name="l00208"></a>00208 <span class="keyword">static</span> <span class="keywordtype">void</span> ec_mbxemergencyerror(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> Slave,<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> ErrorCode,<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> ErrorReg,
<a name="l00209"></a>00209     <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> b1, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> w1, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> w2)
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211     <a class="code" href="../../d3/d91/structec__errort.html" title="Struct to retrieve errors.">ec_errort</a> Ec;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213   gettimeofday(&amp;Ec.<a class="code" href="../../d3/d91/structec__errort.html#a7f0b9956570bf544551d6288519d501c" title="Time at which the error was generated.">Time</a>, 0);
<a name="l00214"></a>00214     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a252e4c13d20d75e0f1cbb7133e02b54e" title="Slave number that generated the error.">Slave</a> = Slave;
<a name="l00215"></a>00215     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a8b5fb38df3f34f4db469708aa81cdaa3" title="CoE SDO index that generated the error.">Index</a> = 0;
<a name="l00216"></a>00216     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a2c0af5d3bb76e00d3449281cbff50d68" title="CoE SDO subindex that generated the error.">SubIdx</a> = 0;
<a name="l00217"></a>00217     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a2482ef37892e8f15c33ce398f6fe34d0" title="Type of error.">Etype</a> = <a class="code" href="../../d2/dbb/ethercattype_8h.html#a190c73e51d0d980cd2f88c95c862f0fca69344d422c20488284993d6705f557fd">EC_ERR_TYPE_EMERGENCY</a>;
<a name="l00218"></a>00218     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a742f3913a82568da85221e7f098ca4aa">ErrorCode</a> = ErrorCode;
<a name="l00219"></a>00219     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a2d90b9efa5ad3153672d1a9b6264eb25">ErrorReg</a> = (<a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>)ErrorReg;
<a name="l00220"></a>00220     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a89b951ee4aae55abe36e4cc5596c7f97">b1</a> = b1;
<a name="l00221"></a>00221     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a9324414d5de575c8932e611cf41064f6">w1</a> = w1;
<a name="l00222"></a>00222     Ec.<a class="code" href="../../d3/d91/structec__errort.html#a1f0207657b22ae784503d61dddb2a02f">w2</a> = w2;
<a name="l00223"></a>00223     <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a91e361f3f3615c5ee22eb17def4d1532" title="Pushes an error on the error list.">ec_pusherror</a>(&amp;Ec);
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 <span class="comment"></span>
<a name="l00226"></a>00226 <span class="comment">/** Initialise lib in single NIC mode</span>
<a name="l00227"></a>00227 <span class="comment"> * @param[in] ifname   = Dev name, f.e. &quot;eth0&quot;</span>
<a name="l00228"></a>00228 <span class="comment"> * @return &gt;0 if OK</span>
<a name="l00229"></a>00229 <span class="comment"> */</span>
<a name="l00230"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a4f50e3fbd5f3d756b4b87043a0f87d62">00230</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a4f50e3fbd5f3d756b4b87043a0f87d62" title="Initialise lib in single NIC mode.">ec_init</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * ifname)
<a name="l00231"></a>00231 {
<a name="l00232"></a>00232   <span class="keywordflow">return</span> <a class="code" href="../../dc/d9b/nicdrv_8c.html#a5b5e0bf5e801e9f30a0fcd9b50b3efc5" title="Basic setup to connect NIC to socket.">ec_setupnic</a>(ifname, <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00233"></a>00233 } 
<a name="l00234"></a>00234 <span class="comment"></span>
<a name="l00235"></a>00235 <span class="comment">/** Initialise lib in redundant NIC mode</span>
<a name="l00236"></a>00236 <span class="comment"> * @param[in] ifname  = Primary Dev name, f.e. &quot;eth0&quot;</span>
<a name="l00237"></a>00237 <span class="comment"> * @param[in] if2name = Secondary Dev name, f.e. &quot;eth1&quot;</span>
<a name="l00238"></a>00238 <span class="comment"> * @return &gt;0 if OK</span>
<a name="l00239"></a>00239 <span class="comment"> */</span>
<a name="l00240"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a4d1d28e0a02ab9dbf743534d399d050e">00240</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a4d1d28e0a02ab9dbf743534d399d050e" title="Initialise lib in redundant NIC mode.">ec_init_redundant</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *ifname, <span class="keyword">const</span> <span class="keywordtype">char</span> *if2name)
<a name="l00241"></a>00241 {
<a name="l00242"></a>00242   <span class="keywordtype">int</span> rval, zbuf;
<a name="l00243"></a>00243   <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">ec_etherheadert</a> *ehp;
<a name="l00244"></a>00244   
<a name="l00245"></a>00245   <a class="code" href="../../dc/d9b/nicdrv_8c.html#a5b5e0bf5e801e9f30a0fcd9b50b3efc5" title="Basic setup to connect NIC to socket.">ec_setupnic</a>(ifname, <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00246"></a>00246   rval = <a class="code" href="../../dc/d9b/nicdrv_8c.html#a5b5e0bf5e801e9f30a0fcd9b50b3efc5" title="Basic setup to connect NIC to socket.">ec_setupnic</a>(if2name, <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00247"></a>00247   <span class="comment">/* prepare &quot;dummy&quot; BRD tx frame for redundant operation */</span>
<a name="l00248"></a>00248   ehp = (<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">ec_etherheadert</a> *)&amp;<a class="code" href="../../dc/d9b/nicdrv_8c.html#a041f8a9db37041e44f598beb671415cd" title="temporary tx buffer">ec_txbuf2</a>;
<a name="l00249"></a>00249   ehp-&gt;<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#ac546a6bc3536671c366bcb016433cc90">sa1</a> = htons(<a class="code" href="../../dc/d9b/nicdrv_8c.html#a1a8704686fbf15b235836459e6d82ebe" title="Secondary source MAC address used for EtherCAT.">secMAC</a>[0]);
<a name="l00250"></a>00250   zbuf = 0;
<a name="l00251"></a>00251   <a class="code" href="../../d5/d74/ethercatbase_8c.html#a3b9a1e2b9fc1e15cf147a85d484db027" title="Generate and set EtherCAT datagram in a standard ethernet frame.">ec_setupdatagram</a>(&amp;<a class="code" href="../../dc/d9b/nicdrv_8c.html#a041f8a9db37041e44f598beb671415cd" title="temporary tx buffer">ec_txbuf2</a>, <a class="code" href="../../d2/dbb/ethercattype_8h.html#ab7e74d81c2756929a05440f98f34b41ba78e5df7e5d625b01108d8daf182b6158" title="Broadcast Read.">EC_CMD_BRD</a>, 0, 0x0000, 0x0000, 2, &amp;zbuf);
<a name="l00252"></a>00252   <a class="code" href="../../dc/d9b/nicdrv_8c.html#a3ef78e050890fa525fd62c00b7bf4e7b" title="temporary tx buffer length">ec_txbuflength2</a> = <a class="code" href="../../d2/dbb/ethercattype_8h.html#abe623cc0ce9e1195985c8cde212c7191" title="ethernet header size">ETH_HEADERSIZE</a> + <a class="code" href="../../d2/dbb/ethercattype_8h.html#abfad83b47bc51994b6e0cdbdd9a6ce64" title="EtherCAT header size.">EC_HEADERSIZE</a> + <a class="code" href="../../d2/dbb/ethercattype_8h.html#a46635ccc69dfc2bf090896f684ad98bc" title="size of workcounter item in EtherCAT datagram">EC_WKCSIZE</a> + 2;
<a name="l00253"></a>00253   
<a name="l00254"></a>00254   <span class="keywordflow">return</span> rval;
<a name="l00255"></a>00255 }
<a name="l00256"></a>00256 <span class="comment"></span>
<a name="l00257"></a>00257 <span class="comment">/** Close lib.</span>
<a name="l00258"></a>00258 <span class="comment"> */</span>
<a name="l00259"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#ab324bdc67988c7eab8dd7324817886cb">00259</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ab324bdc67988c7eab8dd7324817886cb" title="Close lib.">ec_close</a>(<span class="keywordtype">void</span>)
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261   <a class="code" href="../../dc/d9b/nicdrv_8c.html#ab023ae467cce8a520a2554f74415f2ef" title="Close sockets used.">ec_closenic</a>();
<a name="l00262"></a>00262 };  
<a name="l00263"></a>00263 <span class="comment"></span>
<a name="l00264"></a>00264 <span class="comment">/** Read one byte from slave EEPROM via cache.</span>
<a name="l00265"></a>00265 <span class="comment"> *  If the cache location is empty then a read request is made to the slave.</span>
<a name="l00266"></a>00266 <span class="comment"> *  Depending on the slave capabillities the request is 4 or 8 bytes.</span>
<a name="l00267"></a>00267 <span class="comment"> *  @param[in] slave   = slave number</span>
<a name="l00268"></a>00268 <span class="comment"> *  @param[in] address = eeprom address in bytes (slave uses words)</span>
<a name="l00269"></a>00269 <span class="comment"> *  @return requested byte, if not available then 0xff</span>
<a name="l00270"></a>00270 <span class="comment"> */</span>
<a name="l00271"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a6c314f9524aa84af885f1e6426b71148">00271</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> address)
<a name="l00272"></a>00272 {
<a name="l00273"></a>00273   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> configadr, eadr;
<a name="l00274"></a>00274   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a29940ae63ec06c9998bba873e25407ad">uint64</a> edat;
<a name="l00275"></a>00275   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> mapw, mapb;
<a name="l00276"></a>00276   <span class="keywordtype">int</span> lp,cnt;
<a name="l00277"></a>00277   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> retval;
<a name="l00278"></a>00278   
<a name="l00279"></a>00279   retval = 0xff;
<a name="l00280"></a>00280   <span class="keywordflow">if</span> (slave != esislave) <span class="comment">/* not the same slave? */</span>
<a name="l00281"></a>00281   { 
<a name="l00282"></a>00282     memset(esimap,0x00,<a class="code" href="../../d2/dbb/ethercattype_8h.html#adf65441b6852d17f84eb30430e0f3522" title="size of EEPROM bitmap cache">EC_MAXEEPBITMAP</a>); <span class="comment">/* clear esibuf cache map */</span>
<a name="l00283"></a>00283     esislave=slave;
<a name="l00284"></a>00284   } 
<a name="l00285"></a>00285   <span class="keywordflow">if</span> (address &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#a6e94d73c1eb1a9ff2aa0a0b3ac09409a" title="size of EEPROM cache buffer">EC_MAXEEPBUF</a>)
<a name="l00286"></a>00286   {   
<a name="l00287"></a>00287     mapw = address &gt;&gt; 5;
<a name="l00288"></a>00288     mapb = address - (mapw &lt;&lt; 5);
<a name="l00289"></a>00289     <span class="keywordflow">if</span> (esimap[mapw] &amp; (<a class="code" href="../../d2/dbb/ethercattype_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a>)(1 &lt;&lt; mapb))
<a name="l00290"></a>00290     {
<a name="l00291"></a>00291       <span class="comment">/* byte is already in buffer */</span>
<a name="l00292"></a>00292       retval = esibuf[address];
<a name="l00293"></a>00293     }
<a name="l00294"></a>00294     <span class="keywordflow">else</span>
<a name="l00295"></a>00295     {
<a name="l00296"></a>00296       <span class="comment">/* byte is not in buffer, put it there */</span>
<a name="l00297"></a>00297         configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>;
<a name="l00298"></a>00298       <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a027bd337ebfa1d39de8a7a1f5c5287de" title="Set eeprom control to master.">ec_eeprom2master</a>(slave); <span class="comment">/* set eeprom control to master */</span>
<a name="l00299"></a>00299       eadr = address &gt;&gt; 1;
<a name="l00300"></a>00300       edat = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ace89c7536b04427ffb755e77a5525855" title="Read EEPROM from slave bypassing cache.">ec_readeepromFP</a> (configadr, eadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a8684bafce6bd5ae0676fd6440a832276" title="timeout value in us for EEPROM access">EC_TIMEOUTEEP</a>);
<a name="l00301"></a>00301       <span class="comment">/* 8 byte response */</span>
<a name="l00302"></a>00302       <span class="keywordflow">if</span> (ec_slave[slave].eep_8byte)
<a name="l00303"></a>00303       { 
<a name="l00304"></a>00304         <a class="code" href="../../d2/dbb/ethercattype_8h.html#a875b746791fb765f928134436ed4d4b5">put_unaligned64</a>(edat, &amp;esibuf[eadr &lt;&lt; 1]);
<a name="l00305"></a>00305         cnt = 8;
<a name="l00306"></a>00306       }
<a name="l00307"></a>00307       <span class="comment">/* 4 byte response */</span>
<a name="l00308"></a>00308       <span class="keywordflow">else</span>
<a name="l00309"></a>00309       {
<a name="l00310"></a>00310         <a class="code" href="../../d2/dbb/ethercattype_8h.html#ad6e6249350057ec7a8681e6a133b1f3c">put_unaligned32</a>(edat, &amp;esibuf[eadr &lt;&lt; 1]);
<a name="l00311"></a>00311         cnt = 4;
<a name="l00312"></a>00312       }
<a name="l00313"></a>00313       <span class="comment">/* find bitmap location */</span>
<a name="l00314"></a>00314       mapw = eadr &gt;&gt; 4;
<a name="l00315"></a>00315       mapb = (eadr &lt;&lt; 1) - (mapw &lt;&lt; 5);
<a name="l00316"></a>00316       <span class="keywordflow">for</span>(lp = 0 ; lp &lt; cnt ; lp++)
<a name="l00317"></a>00317       {
<a name="l00318"></a>00318         <span class="comment">/* set bitmap for each byte that is read */</span>
<a name="l00319"></a>00319         esimap[mapw] |= (1 &lt;&lt; mapb);
<a name="l00320"></a>00320         mapb++;
<a name="l00321"></a>00321         <span class="keywordflow">if</span> (mapb &gt; 31)
<a name="l00322"></a>00322         {
<a name="l00323"></a>00323           mapb = 0;
<a name="l00324"></a>00324           mapw++;
<a name="l00325"></a>00325         } 
<a name="l00326"></a>00326       } 
<a name="l00327"></a>00327       retval = esibuf[address];
<a name="l00328"></a>00328     } 
<a name="l00329"></a>00329   } 
<a name="l00330"></a>00330   
<a name="l00331"></a>00331   <span class="keywordflow">return</span> retval;
<a name="l00332"></a>00332 } 
<a name="l00333"></a>00333 <span class="comment"></span>
<a name="l00334"></a>00334 <span class="comment">/** Find SII section header in slave EEPROM.</span>
<a name="l00335"></a>00335 <span class="comment"> *  @param[in] slave   = slave number</span>
<a name="l00336"></a>00336 <span class="comment"> *  @param[in] cat     = section category</span>
<a name="l00337"></a>00337 <span class="comment"> *  @return byte address of section at section length entry, if not available then 0</span>
<a name="l00338"></a>00338 <span class="comment"> */</span>
<a name="l00339"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#af44cb7b11dccd4ea221079ae0a8138e8">00339</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a259fa4834387bd68627ddf37bb3ebdb9">int16</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#af44cb7b11dccd4ea221079ae0a8138e8" title="Find SII section header in slave EEPROM.">ec_siifind</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> cat)
<a name="l00340"></a>00340 {
<a name="l00341"></a>00341     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a259fa4834387bd68627ddf37bb3ebdb9">int16</a> a;
<a name="l00342"></a>00342   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> p;
<a name="l00343"></a>00343   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> eectl = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#ae42d1bcef392fdd8e18b2499ab8f11ef" title="0 = eeprom to master , 1 = eeprom to PDI">eep_pdi</a>;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     a = <a class="code" href="../../d2/dbb/ethercattype_8h.html#a3f4a71ab602c23ce1d5b3a7c539a444f" title="Start address SII sections in Eeprom.">ECT_SII_START</a> &lt;&lt; 1;
<a name="l00346"></a>00346   <span class="comment">/* read first SII section category */</span>
<a name="l00347"></a>00347   p = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00348"></a>00348   p += (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++) &lt;&lt; 8);
<a name="l00349"></a>00349   <span class="comment">/* traverse SII while category is not found and not EOF */</span>
<a name="l00350"></a>00350     <span class="keywordflow">while</span> ((p != cat) &amp;&amp; (p != 0xffff))
<a name="l00351"></a>00351     {
<a name="l00352"></a>00352     <span class="comment">/* read section length */</span>
<a name="l00353"></a>00353     p = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00354"></a>00354     p += (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++) &lt;&lt; 8);
<a name="l00355"></a>00355     <span class="comment">/* locate next section category */</span>
<a name="l00356"></a>00356         a += p &lt;&lt; 1;
<a name="l00357"></a>00357     <span class="comment">/* read section category */</span>
<a name="l00358"></a>00358     p = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00359"></a>00359     p += (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++) &lt;&lt; 8);
<a name="l00360"></a>00360     }
<a name="l00361"></a>00361     <span class="keywordflow">if</span> (p != cat)
<a name="l00362"></a>00362         a = 0;
<a name="l00363"></a>00363 
<a name="l00364"></a>00364   <span class="keywordflow">if</span> (eectl) <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ae149a6cd4a61c22efa4cf4185ffd83be" title="Set eeprom control to PDI.">ec_eeprom2pdi</a>(slave); <span class="comment">/* if eeprom control was previously pdi then restore */</span>
<a name="l00365"></a>00365 
<a name="l00366"></a>00366   <span class="keywordflow">return</span> a;
<a name="l00367"></a>00367 }
<a name="l00368"></a>00368 <span class="comment"></span>
<a name="l00369"></a>00369 <span class="comment">/** Get string from SII string section in slave EEPROM.</span>
<a name="l00370"></a>00370 <span class="comment"> *  @param[out] str = requested string, 0x00 if not found</span>
<a name="l00371"></a>00371 <span class="comment"> *  @param[in] slave   = slave number</span>
<a name="l00372"></a>00372 <span class="comment"> *  @param[in] Sn    = string number</span>
<a name="l00373"></a>00373 <span class="comment"> */</span>
<a name="l00374"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a4fe43f91402e635e7087b9f1e09d7703">00374</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a4fe43f91402e635e7087b9f1e09d7703" title="Get string from SII string section in slave EEPROM.">ec_siistring</a>(<span class="keywordtype">char</span> *str, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> Sn)
<a name="l00375"></a>00375 {
<a name="l00376"></a>00376     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> a,i,j,l,n,ba,p;
<a name="l00377"></a>00377     <span class="keywordtype">char</span> *ptr;
<a name="l00378"></a>00378   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> eectl = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#ae42d1bcef392fdd8e18b2499ab8f11ef" title="0 = eeprom to master , 1 = eeprom to PDI">eep_pdi</a>;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     ptr = str;
<a name="l00381"></a>00381     p = 0;
<a name="l00382"></a>00382     a = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#af44cb7b11dccd4ea221079ae0a8138e8" title="Find SII section header in slave EEPROM.">ec_siifind</a> (slave, <a class="code" href="../../d2/dbb/ethercattype_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8af250e5ba38d5f1420ee05e2da1f866c0" title="SII category strings.">ECT_SII_STRING</a>); <span class="comment">/* find string section */</span>
<a name="l00383"></a>00383     <span class="keywordflow">if</span> (a &gt; 0)
<a name="l00384"></a>00384     {
<a name="l00385"></a>00385         ba = a + 2; <span class="comment">/* skip SII section header */</span>
<a name="l00386"></a>00386         n = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, ba++); <span class="comment">/* read number of strings in section */</span>
<a name="l00387"></a>00387         <span class="keywordflow">if</span> (Sn &lt;= n) <span class="comment">/* is req string available? */</span>
<a name="l00388"></a>00388         {
<a name="l00389"></a>00389             <span class="keywordflow">for</span> (i = 1; i &lt;= Sn; i++) <span class="comment">/* walk through strings */</span>
<a name="l00390"></a>00390             {
<a name="l00391"></a>00391                 l = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, ba++); <span class="comment">/* length of this string */</span>
<a name="l00392"></a>00392                 ptr = str;
<a name="l00393"></a>00393                 <span class="keywordflow">for</span> (j = 1; j &lt;= l; j++) <span class="comment">/* copy one string */</span>
<a name="l00394"></a>00394                 {
<a name="l00395"></a>00395                     *ptr = (char)<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, ba++);
<a name="l00396"></a>00396           ptr++;
<a name="l00397"></a>00397                 }
<a name="l00398"></a>00398             }
<a name="l00399"></a>00399             *ptr = 0; <span class="comment">/* add zero terminator */</span>
<a name="l00400"></a>00400         }
<a name="l00401"></a>00401     <span class="keywordflow">else</span>
<a name="l00402"></a>00402     {
<a name="l00403"></a>00403       ptr = str;
<a name="l00404"></a>00404       *ptr = 0; <span class="comment">/* empty string */</span>
<a name="l00405"></a>00405     } 
<a name="l00406"></a>00406     }
<a name="l00407"></a>00407   <span class="keywordflow">if</span> (eectl) <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ae149a6cd4a61c22efa4cf4185ffd83be" title="Set eeprom control to PDI.">ec_eeprom2pdi</a>(slave); <span class="comment">/* if eeprom control was previously pdi then restore */</span>
<a name="l00408"></a>00408 }
<a name="l00409"></a>00409 <span class="comment"></span>
<a name="l00410"></a>00410 <span class="comment">/** Get FMMU data from SII FMMU section in slave EEPROM.</span>
<a name="l00411"></a>00411 <span class="comment"> *  @param[in] slave   = slave number</span>
<a name="l00412"></a>00412 <span class="comment"> *  @param[out] FMMU   = FMMU struct from SII, max. 4 FMMU&#39;s</span>
<a name="l00413"></a>00413 <span class="comment"> *  @return number of FMMU&#39;s defined in section</span>
<a name="l00414"></a>00414 <span class="comment"> */</span>
<a name="l00415"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#ab382409c9f74891f82e87dcc7fad875e">00415</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ab382409c9f74891f82e87dcc7fad875e" title="Get FMMU data from SII FMMU section in slave EEPROM.">ec_siiFMMU</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html" title="SII FMMU structure.">ec_eepromFMMUt</a>* FMMU)
<a name="l00416"></a>00416 {
<a name="l00417"></a>00417   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a>  a;
<a name="l00418"></a>00418   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> eectl = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#ae42d1bcef392fdd8e18b2499ab8f11ef" title="0 = eeprom to master , 1 = eeprom to PDI">eep_pdi</a>;
<a name="l00419"></a>00419   
<a name="l00420"></a>00420     FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#ae86d07f5f0759c26dd3fca9fcdfb2cb6">nFMMU</a> = 0;
<a name="l00421"></a>00421     FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#aa85efbc1b29023a1cb56ca7e6ec9b417">FMMU0</a> = 0;
<a name="l00422"></a>00422     FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#aae020e9d0388764326166abc6f2ae10f">FMMU1</a> = 0;
<a name="l00423"></a>00423     FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#a080d7ef14a82ff734668ec82dbcda6c0">FMMU2</a> = 0;
<a name="l00424"></a>00424     FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#a0d687668e0cf743b007411e476a1559f">FMMU3</a> = 0;
<a name="l00425"></a>00425     FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#ad0c9a33d8573e962804ac7bb1bfd7d70">Startpos</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#af44cb7b11dccd4ea221079ae0a8138e8" title="Find SII section header in slave EEPROM.">ec_siifind</a>(slave, <a class="code" href="../../d2/dbb/ethercattype_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a44d345a184cf7b4dce290a77c2edafa1" title="SII category FMMU.">ECT_SII_FMMU</a>);
<a name="l00426"></a>00426 
<a name="l00427"></a>00427     <span class="keywordflow">if</span> (FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#ad0c9a33d8573e962804ac7bb1bfd7d70">Startpos</a> &gt; 0)
<a name="l00428"></a>00428     {
<a name="l00429"></a>00429     a = FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#ad0c9a33d8573e962804ac7bb1bfd7d70">Startpos</a>;
<a name="l00430"></a>00430         FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#ae86d07f5f0759c26dd3fca9fcdfb2cb6">nFMMU</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00431"></a>00431     FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#ae86d07f5f0759c26dd3fca9fcdfb2cb6">nFMMU</a> += (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++) &lt;&lt; 8);
<a name="l00432"></a>00432     FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#ae86d07f5f0759c26dd3fca9fcdfb2cb6">nFMMU</a> *= 2;
<a name="l00433"></a>00433         FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#aa85efbc1b29023a1cb56ca7e6ec9b417">FMMU0</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00434"></a>00434         FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#aae020e9d0388764326166abc6f2ae10f">FMMU1</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00435"></a>00435         <span class="keywordflow">if</span> (FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#ae86d07f5f0759c26dd3fca9fcdfb2cb6">nFMMU</a> &gt; 2)
<a name="l00436"></a>00436         {
<a name="l00437"></a>00437             FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#a080d7ef14a82ff734668ec82dbcda6c0">FMMU2</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00438"></a>00438             FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#a0d687668e0cf743b007411e476a1559f">FMMU3</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441   <span class="keywordflow">if</span> (eectl) <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ae149a6cd4a61c22efa4cf4185ffd83be" title="Set eeprom control to PDI.">ec_eeprom2pdi</a>(slave); <span class="comment">/* if eeprom control was previously pdi then restore */</span>
<a name="l00442"></a>00442     <span class="keywordflow">return</span> FMMU-&gt;<a class="code" href="../../d6/ddd/structec__eeprom_f_m_m_ut.html#ae86d07f5f0759c26dd3fca9fcdfb2cb6">nFMMU</a>;
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 <span class="comment"></span>
<a name="l00445"></a>00445 <span class="comment">/** Get SM data from SII SM section in slave EEPROM.</span>
<a name="l00446"></a>00446 <span class="comment"> *  @param[in] slave   = slave number</span>
<a name="l00447"></a>00447 <span class="comment"> *  @param[out] SM     = first SM struct from SII</span>
<a name="l00448"></a>00448 <span class="comment"> *  @return number of SM&#39;s defined in section</span>
<a name="l00449"></a>00449 <span class="comment"> */</span>
<a name="l00450"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a54c0c0d13f6c7b38e98ab91f4db29514">00450</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a54c0c0d13f6c7b38e98ab91f4db29514" title="Get SM data from SII SM section in slave EEPROM.">ec_siiSM</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <a class="code" href="../../de/d35/structec__eeprom_s_mt.html" title="SII SM structure.">ec_eepromSMt</a>* SM)
<a name="l00451"></a>00451 {
<a name="l00452"></a>00452     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> a,w,l;
<a name="l00453"></a>00453   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> eectl = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#ae42d1bcef392fdd8e18b2499ab8f11ef" title="0 = eeprom to master , 1 = eeprom to PDI">eep_pdi</a>;
<a name="l00454"></a>00454 
<a name="l00455"></a>00455     SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a2b08f8efdf4af5e1dba95cc07f16aa75">nSM</a> = 0;
<a name="l00456"></a>00456     l = 0;
<a name="l00457"></a>00457     SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#ad0c9a33d8573e962804ac7bb1bfd7d70">Startpos</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#af44cb7b11dccd4ea221079ae0a8138e8" title="Find SII section header in slave EEPROM.">ec_siifind</a>(slave, <a class="code" href="../../d2/dbb/ethercattype_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a9dc9679db1b079332f5e789941fe6127" title="SII category SM.">ECT_SII_SM</a>);
<a name="l00458"></a>00458     <span class="keywordflow">if</span> (SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#ad0c9a33d8573e962804ac7bb1bfd7d70">Startpos</a> &gt; 0)
<a name="l00459"></a>00459     {
<a name="l00460"></a>00460     a = SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#ad0c9a33d8573e962804ac7bb1bfd7d70">Startpos</a>;   
<a name="l00461"></a>00461     w = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00462"></a>00462     w += (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++) &lt;&lt; 8);
<a name="l00463"></a>00463         SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a2b08f8efdf4af5e1dba95cc07f16aa75">nSM</a> = (w / 4);
<a name="l00464"></a>00464         SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a5cea89c3ea23b79bb601189e717251f7">PhStart</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00465"></a>00465     SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a5cea89c3ea23b79bb601189e717251f7">PhStart</a> += (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++) &lt;&lt; 8);
<a name="l00466"></a>00466         SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a7e5e36fd01beb50acd0a7482d54fcf7c">Plength</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00467"></a>00467     SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a7e5e36fd01beb50acd0a7482d54fcf7c">Plength</a> += (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++) &lt;&lt; 8);
<a name="l00468"></a>00468         SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a70f0f9c7b06477ee9217a0097ac283bb">Creg</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00469"></a>00469         SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a259cd75801bf3bcda79d86a1e33c2ba3">Sreg</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00470"></a>00470         SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a3dfd55eacb8202b3a99d5a2a8913b430">Activate</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00471"></a>00471         SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a67b75391a1e420acf7c73db74f48342a">PDIctrl</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00472"></a>00472     }
<a name="l00473"></a>00473   <span class="keywordflow">if</span> (eectl) <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ae149a6cd4a61c22efa4cf4185ffd83be" title="Set eeprom control to PDI.">ec_eeprom2pdi</a>(slave); <span class="comment">/* if eeprom control was previously pdi then restore */</span>
<a name="l00474"></a>00474     <span class="keywordflow">return</span> SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a2b08f8efdf4af5e1dba95cc07f16aa75">nSM</a>;
<a name="l00475"></a>00475 }
<a name="l00476"></a>00476 <span class="comment"></span>
<a name="l00477"></a>00477 <span class="comment">/** Get next SM data from SII SM section in slave EEPROM.</span>
<a name="l00478"></a>00478 <span class="comment"> *  @param[in] slave   = slave number</span>
<a name="l00479"></a>00479 <span class="comment"> *  @param[out] SM     = first SM struct from SII</span>
<a name="l00480"></a>00480 <span class="comment"> *  @param[in] n     = SM number</span>
<a name="l00481"></a>00481 <span class="comment"> *  @return &gt;0 if OK</span>
<a name="l00482"></a>00482 <span class="comment"> */</span>
<a name="l00483"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#acfb749a5fbaaa6d560204757be2170f5">00483</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#acfb749a5fbaaa6d560204757be2170f5" title="Get next SM data from SII SM section in slave EEPROM.">ec_siiSMnext</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <a class="code" href="../../de/d35/structec__eeprom_s_mt.html" title="SII SM structure.">ec_eepromSMt</a>* SM, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> n)
<a name="l00484"></a>00484 {
<a name="l00485"></a>00485     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> a;
<a name="l00486"></a>00486     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> retVal = 0;
<a name="l00487"></a>00487   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> eectl = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#ae42d1bcef392fdd8e18b2499ab8f11ef" title="0 = eeprom to master , 1 = eeprom to PDI">eep_pdi</a>;
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     <span class="keywordflow">if</span> (n &lt; SM-&gt;nSM)
<a name="l00490"></a>00490     {
<a name="l00491"></a>00491         a = SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#ad0c9a33d8573e962804ac7bb1bfd7d70">Startpos</a> + 2 + (n * 8);
<a name="l00492"></a>00492         SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a5cea89c3ea23b79bb601189e717251f7">PhStart</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00493"></a>00493     SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a5cea89c3ea23b79bb601189e717251f7">PhStart</a> += (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++) &lt;&lt; 8);
<a name="l00494"></a>00494         SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a7e5e36fd01beb50acd0a7482d54fcf7c">Plength</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00495"></a>00495     SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a7e5e36fd01beb50acd0a7482d54fcf7c">Plength</a> += (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++) &lt;&lt; 8);
<a name="l00496"></a>00496         SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a70f0f9c7b06477ee9217a0097ac283bb">Creg</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00497"></a>00497         SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a259cd75801bf3bcda79d86a1e33c2ba3">Sreg</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00498"></a>00498         SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a3dfd55eacb8202b3a99d5a2a8913b430">Activate</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00499"></a>00499         SM-&gt;<a class="code" href="../../de/d35/structec__eeprom_s_mt.html#a67b75391a1e420acf7c73db74f48342a">PDIctrl</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00500"></a>00500         retVal = 1;
<a name="l00501"></a>00501     }
<a name="l00502"></a>00502   <span class="keywordflow">if</span> (eectl) <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ae149a6cd4a61c22efa4cf4185ffd83be" title="Set eeprom control to PDI.">ec_eeprom2pdi</a>(slave); <span class="comment">/* if eeprom control was previously pdi then restore */</span>
<a name="l00503"></a>00503     <span class="keywordflow">return</span> retVal;
<a name="l00504"></a>00504 }
<a name="l00505"></a>00505 <span class="comment"></span>
<a name="l00506"></a>00506 <span class="comment">/** Get PDO data from SII PDO section in slave EEPROM.</span>
<a name="l00507"></a>00507 <span class="comment"> *  @param[in] slave  = slave number</span>
<a name="l00508"></a>00508 <span class="comment"> *  @param[out] PDO   = PDO struct from SII</span>
<a name="l00509"></a>00509 <span class="comment"> *  @param[in] t    = 0=RXPDO 1=TXPDO</span>
<a name="l00510"></a>00510 <span class="comment"> *  @return mapping size in bits of PDO</span>
<a name="l00511"></a>00511 <span class="comment"> */</span>
<a name="l00512"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#aef972d9668958da9db3c350e159caddb">00512</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#aef972d9668958da9db3c350e159caddb" title="Get PDO data from SII PDO section in slave EEPROM.">ec_siiPDO</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html" title="record to store rxPDO and txPDO table from eeprom">ec_eepromPDOt</a>* PDO, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> t)
<a name="l00513"></a>00513 {
<a name="l00514"></a>00514     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> a , w, c, e, er, Size;
<a name="l00515"></a>00515   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> eectl = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#ae42d1bcef392fdd8e18b2499ab8f11ef" title="0 = eeprom to master , 1 = eeprom to PDI">eep_pdi</a>;
<a name="l00516"></a>00516 
<a name="l00517"></a>00517   Size = 0;
<a name="l00518"></a>00518     PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a008118888424ebe707b5c61317238a2e">nPDO</a> = 0;
<a name="l00519"></a>00519     PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a43c6284c3546de2dc28b806691a715f4">Length</a> = 0;
<a name="l00520"></a>00520     PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#ab41e25038a14f2ea38f58cd6501566a7">Index</a>[1] = 0;
<a name="l00521"></a>00521   <span class="keywordflow">for</span> (c = 0 ; c &lt; <a class="code" href="../../d8/d38/ethercatmain_8h.html#a76097f1d16afaffe412d6f3d864ac749">EC_MAXSM</a> ; c++) PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a91a434c6802e7286c6283d6ee6c74a83">SMbitsize</a>[c] = 0;
<a name="l00522"></a>00522     if (t &gt; 1)
<a name="l00523"></a>00523         t = 1;
<a name="l00524"></a>00524     PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#ad0c9a33d8573e962804ac7bb1bfd7d70">Startpos</a> = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#af44cb7b11dccd4ea221079ae0a8138e8" title="Find SII section header in slave EEPROM.">ec_siifind</a>(slave, <a class="code" href="../../d2/dbb/ethercattype_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a883dac9077f7afe10f4999b718b1fbd6" title="SII category PDO.">ECT_SII_PDO</a> + t);
<a name="l00525"></a>00525     <span class="keywordflow">if</span> (PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#ad0c9a33d8573e962804ac7bb1bfd7d70">Startpos</a> &gt; 0)
<a name="l00526"></a>00526     {
<a name="l00527"></a>00527     a = PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#ad0c9a33d8573e962804ac7bb1bfd7d70">Startpos</a>;
<a name="l00528"></a>00528     w = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00529"></a>00529     w += (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++) &lt;&lt; 8);
<a name="l00530"></a>00530         PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a43c6284c3546de2dc28b806691a715f4">Length</a> = w;
<a name="l00531"></a>00531         c = 1;
<a name="l00532"></a>00532     <span class="comment">/* traverse through all PDOs */</span>
<a name="l00533"></a>00533         <span class="keywordflow">do</span>
<a name="l00534"></a>00534         {
<a name="l00535"></a>00535             PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a008118888424ebe707b5c61317238a2e">nPDO</a>++;
<a name="l00536"></a>00536             PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#ab41e25038a14f2ea38f58cd6501566a7">Index</a>[PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a008118888424ebe707b5c61317238a2e">nPDO</a>] = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00537"></a>00537       PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#ab41e25038a14f2ea38f58cd6501566a7">Index</a>[PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a008118888424ebe707b5c61317238a2e">nPDO</a>] += (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++) &lt;&lt; 8);
<a name="l00538"></a>00538             PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a7900182b4f24a666e4d60b0a66c65de6">BitSize</a>[PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a008118888424ebe707b5c61317238a2e">nPDO</a>] = 0;
<a name="l00539"></a>00539             c++;
<a name="l00540"></a>00540             e = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00541"></a>00541             PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#aaf9b6e3fa4c4fc55f1ce2203430dfff2">SyncM</a>[PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a008118888424ebe707b5c61317238a2e">nPDO</a>] = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00542"></a>00542       a += 4;
<a name="l00543"></a>00543             c += 2;
<a name="l00544"></a>00544       <span class="keywordflow">if</span> (PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#aaf9b6e3fa4c4fc55f1ce2203430dfff2">SyncM</a>[PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a008118888424ebe707b5c61317238a2e">nPDO</a>] &lt; EC_MAXSM) <span class="comment">/* active and in range SM? */</span>
<a name="l00545"></a>00545       { 
<a name="l00546"></a>00546         <span class="comment">/* read all entries defined in PDO */</span>
<a name="l00547"></a>00547               <span class="keywordflow">for</span> (er = 1; er &lt;= e; er++)
<a name="l00548"></a>00548             {
<a name="l00549"></a>00549                 c += 4;
<a name="l00550"></a>00550           a += 5;
<a name="l00551"></a>00551                   PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a7900182b4f24a666e4d60b0a66c65de6">BitSize</a>[PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a008118888424ebe707b5c61317238a2e">nPDO</a>] += <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a6c314f9524aa84af885f1e6426b71148" title="Read one byte from slave EEPROM via cache.">ec_siigetbyte</a>(slave, a++);
<a name="l00552"></a>00552           a += 2;
<a name="l00553"></a>00553             }
<a name="l00554"></a>00554         PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a91a434c6802e7286c6283d6ee6c74a83">SMbitsize</a>[ PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#aaf9b6e3fa4c4fc55f1ce2203430dfff2">SyncM</a>[PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a008118888424ebe707b5c61317238a2e">nPDO</a>] ] += PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a7900182b4f24a666e4d60b0a66c65de6">BitSize</a>[PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a008118888424ebe707b5c61317238a2e">nPDO</a>];
<a name="l00555"></a>00555         Size += PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a7900182b4f24a666e4d60b0a66c65de6">BitSize</a>[PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a008118888424ebe707b5c61317238a2e">nPDO</a>];
<a name="l00556"></a>00556             c++;
<a name="l00557"></a>00557       }
<a name="l00558"></a>00558       <span class="keywordflow">else</span> <span class="comment">/* PDO deactivated because SM is 0xff or &gt; EC_MAXSM */</span>
<a name="l00559"></a>00559       {
<a name="l00560"></a>00560         c += 4 * e;
<a name="l00561"></a>00561         a += 8 * e;
<a name="l00562"></a>00562         c++;
<a name="l00563"></a>00563       } 
<a name="l00564"></a>00564       <span class="keywordflow">if</span> (PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a008118888424ebe707b5c61317238a2e">nPDO</a> &gt;= (<a class="code" href="../../d8/d38/ethercatmain_8h.html#a723692b19e6e31099fce70354767eb6d">EC_MAXEEPDO</a> - 1)) c = PDO-&gt;<a class="code" href="../../d9/de1/structec__eeprom_p_d_ot.html#a43c6284c3546de2dc28b806691a715f4">Length</a>; <span class="comment">/* limit number of PDO entries in buffer */</span>
<a name="l00565"></a>00565         }
<a name="l00566"></a>00566         <span class="keywordflow">while</span> (c &lt; PDO-&gt;Length);
<a name="l00567"></a>00567     }
<a name="l00568"></a>00568   <span class="keywordflow">if</span> (eectl) <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ae149a6cd4a61c22efa4cf4185ffd83be" title="Set eeprom control to PDI.">ec_eeprom2pdi</a>(slave); <span class="comment">/* if eeprom control was previously pdi then restore */</span>
<a name="l00569"></a>00569 
<a name="l00570"></a>00570     <span class="keywordflow">return</span> (Size);
<a name="l00571"></a>00571 }
<a name="l00572"></a>00572 <span class="comment"></span>
<a name="l00573"></a>00573 <span class="comment">/** Read all slave states in ec_slave. </span>
<a name="l00574"></a>00574 <span class="comment"> * @return lowest state found</span>
<a name="l00575"></a>00575 <span class="comment"> */</span>
<a name="l00576"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a585d9cd831f1d43f1bbaf7a50ee9759c">00576</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a585d9cd831f1d43f1bbaf7a50ee9759c" title="Read all slave states in ec_slave.">ec_readstate</a>(<span class="keywordtype">void</span>)
<a name="l00577"></a>00577 {
<a name="l00578"></a>00578     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, configadr, lowest, rval;
<a name="l00579"></a>00579   <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">ec_alstatust</a> slstat;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581   lowest = 0xff;
<a name="l00582"></a>00582   ec_slave[0].<a class="code" href="../../da/dff/structec__slavet.html#ad9f61d22616972eef76e451ef9ff65b3" title="AL status code.">ALstatuscode</a> = 0;
<a name="l00583"></a>00583     <span class="keywordflow">for</span> (slave = 1; slave &lt;= <a class="code" href="../../d3/d6b/ethercatmain_8c.html#aa9c784abc9a4ede41d3d8d688b4a7dc5" title="number of slaves found on the network">ec_slavecount</a>; slave++)
<a name="l00584"></a>00584     {
<a name="l00585"></a>00585         configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>;
<a name="l00586"></a>00586     slstat.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#a7cf6900202bcffed030b16df9c9507ed">alstatus</a> = 0;
<a name="l00587"></a>00587     slstat.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#a0f1b680430c9be3c700f45e434de05e7">alstatuscode</a> = 0;
<a name="l00588"></a>00588         <a class="code" href="../../d5/d74/ethercatbase_8c.html#aac2dc2b5a39ace0793473ab89bb56c7d" title="FPRD &amp;quot;configured address read&amp;quot; primitive.">ec_FPRD</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409acca77fadd0ad64c5e564c55916491a78">ECT_REG_ALSTAT</a>, <span class="keyword">sizeof</span>(slstat), &amp;slstat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l00589"></a>00589     rval = etohs(slstat.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#a7cf6900202bcffed030b16df9c9507ed">alstatus</a>);
<a name="l00590"></a>00590     ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#ad9f61d22616972eef76e451ef9ff65b3" title="AL status code.">ALstatuscode</a> = etohs(slstat.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#a0f1b680430c9be3c700f45e434de05e7">alstatuscode</a>);
<a name="l00591"></a>00591     <span class="keywordflow">if</span> (rval &lt; lowest)
<a name="l00592"></a>00592       lowest = rval;
<a name="l00593"></a>00593     ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#a0012a170532a3c10ab464d0c8a7245ec" title="state of slave">state</a> = rval;
<a name="l00594"></a>00594     ec_slave[0].<a class="code" href="../../da/dff/structec__slavet.html#ad9f61d22616972eef76e451ef9ff65b3" title="AL status code.">ALstatuscode</a> |= ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#ad9f61d22616972eef76e451ef9ff65b3" title="AL status code.">ALstatuscode</a>;
<a name="l00595"></a>00595     }
<a name="l00596"></a>00596   ec_slave[0].<a class="code" href="../../da/dff/structec__slavet.html#a0012a170532a3c10ab464d0c8a7245ec" title="state of slave">state</a> = lowest;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598     <span class="keywordflow">return</span> lowest;
<a name="l00599"></a>00599 }
<a name="l00600"></a>00600 <span class="comment"></span>
<a name="l00601"></a>00601 <span class="comment">/** Write slave state, if slave = 0 then write to all slaves.</span>
<a name="l00602"></a>00602 <span class="comment"> * The function does not check if the actual state is changed.</span>
<a name="l00603"></a>00603 <span class="comment"> * @param[in] slave = Slave number, 0 = master</span>
<a name="l00604"></a>00604 <span class="comment"> * @return 0</span>
<a name="l00605"></a>00605 <span class="comment"> */</span>
<a name="l00606"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a0750885eaa4230b7815a84ce8d627984">00606</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a0750885eaa4230b7815a84ce8d627984" title="Write slave state, if slave = 0 then write to all slaves.">ec_writestate</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>)
<a name="l00607"></a>00607 {
<a name="l00608"></a>00608     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> configadr, slstate;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610   <span class="keywordflow">if</span> (slave == 0)
<a name="l00611"></a>00611   {
<a name="l00612"></a>00612     slstate = htoes(ec_slave[slave].state);
<a name="l00613"></a>00613     <a class="code" href="../../d5/d74/ethercatbase_8c.html#a3ad29de613339c69a0b132114928b208" title="BRW &amp;quot;broadcast write&amp;quot; primitive.">ec_BWR</a>(0, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a148befce8c8d150d28b6a93d37fe24c2">ECT_REG_ALCTL</a>, <span class="keyword">sizeof</span>(slstate), &amp;slstate, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>); <span class="comment">/* write slave status */</span>
<a name="l00614"></a>00614   }
<a name="l00615"></a>00615   <span class="keywordflow">else</span>
<a name="l00616"></a>00616   {
<a name="l00617"></a>00617     configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>;
<a name="l00618"></a>00618     <a class="code" href="../../d5/d74/ethercatbase_8c.html#a2fc76bd01a00a0f6da9fb3927eabc24d" title="FPWR &amp;quot;configured address write&amp;quot; primitive.">ec_FPWRw</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a148befce8c8d150d28b6a93d37fe24c2">ECT_REG_ALCTL</a>, htoes(ec_slave[slave].state), <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>); <span class="comment">/* write slave status */</span>
<a name="l00619"></a>00619   }
<a name="l00620"></a>00620   <span class="keywordflow">return</span> 0;
<a name="l00621"></a>00621 }
<a name="l00622"></a>00622 <span class="comment"></span>
<a name="l00623"></a>00623 <span class="comment">/** Check actual slave state.</span>
<a name="l00624"></a>00624 <span class="comment"> * This is a blocking function.</span>
<a name="l00625"></a>00625 <span class="comment"> * @param[in] slave   = Slave number, 0 = all slaves</span>
<a name="l00626"></a>00626 <span class="comment"> * @param[in] reqstate  = Requested state</span>
<a name="l00627"></a>00627 <span class="comment"> * @param[in] timeout = Timout value in us</span>
<a name="l00628"></a>00628 <span class="comment"> * @return Requested state, or found state after timeout.</span>
<a name="l00629"></a>00629 <span class="comment"> */</span>
<a name="l00630"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a8f77918c0a6a32be1079a11119171901">00630</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a8f77918c0a6a32be1079a11119171901" title="Check actual slave state.">ec_statecheck</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> reqstate, <span class="keywordtype">int</span> timeout)
<a name="l00631"></a>00631 {
<a name="l00632"></a>00632     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> configadr, state, rval;
<a name="l00633"></a>00633   <span class="keyword">struct </span>timeval tv1, tv2, tve;
<a name="l00634"></a>00634   <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">ec_alstatust</a> slstat;
<a name="l00635"></a>00635   
<a name="l00636"></a>00636   <span class="keywordflow">if</span> ( slave &gt; <a class="code" href="../../d3/d6b/ethercatmain_8c.html#aa9c784abc9a4ede41d3d8d688b4a7dc5" title="number of slaves found on the network">ec_slavecount</a> ) <span class="keywordflow">return</span> 0;
<a name="l00637"></a>00637   gettimeofday(&amp;tv1, 0);
<a name="l00638"></a>00638   tv2.tv_sec = 0;
<a name="l00639"></a>00639   tv2.tv_usec = timeout;
<a name="l00640"></a>00640   timeradd(&amp;tv1, &amp;tv2, &amp;tve);
<a name="l00641"></a>00641     configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>;
<a name="l00642"></a>00642     <span class="keywordflow">do</span>
<a name="l00643"></a>00643     {
<a name="l00644"></a>00644     <span class="keywordflow">if</span> (slave &lt; 1)
<a name="l00645"></a>00645     {
<a name="l00646"></a>00646       rval = 0;
<a name="l00647"></a>00647           <a class="code" href="../../d5/d74/ethercatbase_8c.html#a30d9ab75b270ba904509fb1af2b8dc17" title="BRD &amp;quot;broadcast read&amp;quot; primitive.">ec_BRD</a>(0, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409acca77fadd0ad64c5e564c55916491a78">ECT_REG_ALSTAT</a>, <span class="keyword">sizeof</span>(rval), &amp;rval , <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l00648"></a>00648       rval = etohs(rval);
<a name="l00649"></a>00649     }
<a name="l00650"></a>00650     <span class="keywordflow">else</span>
<a name="l00651"></a>00651     { 
<a name="l00652"></a>00652       slstat.alstatus = 0;
<a name="l00653"></a>00653       slstat.alstatuscode = 0;
<a name="l00654"></a>00654           <a class="code" href="../../d5/d74/ethercatbase_8c.html#aac2dc2b5a39ace0793473ab89bb56c7d" title="FPRD &amp;quot;configured address read&amp;quot; primitive.">ec_FPRD</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409acca77fadd0ad64c5e564c55916491a78">ECT_REG_ALSTAT</a>, <span class="keyword">sizeof</span>(slstat), &amp;slstat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l00655"></a>00655       rval = etohs(slstat.alstatus);
<a name="l00656"></a>00656       ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#ad9f61d22616972eef76e451ef9ff65b3" title="AL status code.">ALstatuscode</a> = etohs(slstat.alstatuscode);
<a name="l00657"></a>00657     }
<a name="l00658"></a>00658     state = rval &amp; 0x000f; <span class="comment">/* read slave status */</span>
<a name="l00659"></a>00659         <span class="keywordflow">if</span> (state != reqstate) usleep(1000);
<a name="l00660"></a>00660     gettimeofday(&amp;tv2, 0);
<a name="l00661"></a>00661     }
<a name="l00662"></a>00662   <span class="keywordflow">while</span> ((state != reqstate) &amp;&amp; timercmp(&amp;tv2, &amp;tve, &lt;));
<a name="l00663"></a>00663     ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#a0012a170532a3c10ab464d0c8a7245ec" title="state of slave">state</a> = rval;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665   <span class="keywordflow">return</span> state;
<a name="l00666"></a>00666 }
<a name="l00667"></a>00667 <span class="comment"></span>
<a name="l00668"></a>00668 <span class="comment">/** Get index of next mailbox counter value.</span>
<a name="l00669"></a>00669 <span class="comment"> * Used for Mailbox Link Layer.</span>
<a name="l00670"></a>00670 <span class="comment"> * @param[in] cnt   = Mailbox counter value [0..7]</span>
<a name="l00671"></a>00671 <span class="comment"> * @return next mailbox counter value</span>
<a name="l00672"></a>00672 <span class="comment"> */</span>
<a name="l00673"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a1e178403f6eb467358bdfcc9eb086691">00673</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a1e178403f6eb467358bdfcc9eb086691" title="Get index of next mailbox counter value.">ec_nextmbxcnt</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> cnt)
<a name="l00674"></a>00674 {
<a name="l00675"></a>00675     cnt++;
<a name="l00676"></a>00676     <span class="keywordflow">if</span> (cnt &gt; 7)
<a name="l00677"></a>00677         cnt = 1; <span class="comment">/* wrap around to 1, not 0 */</span>
<a name="l00678"></a>00678     <span class="keywordflow">return</span> cnt;
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 <span class="comment"></span>
<a name="l00681"></a>00681 <span class="comment">/** Clear mailbox buffer.</span>
<a name="l00682"></a>00682 <span class="comment"> * @param[out] Mbx    = Mailbox buffer to clear</span>
<a name="l00683"></a>00683 <span class="comment"> */</span>
<a name="l00684"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a652d40885e8275a02ddcf94fbd077c99">00684</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a652d40885e8275a02ddcf94fbd077c99" title="Clear mailbox buffer.">ec_clearmbx</a>(<a class="code" href="../../d8/d38/ethercatmain_8h.html#ac62bb7429de1cb16707a415b240e590d" title="mailbox buffer array">ec_mbxbuft</a> *Mbx)
<a name="l00685"></a>00685 {
<a name="l00686"></a>00686     memset(*Mbx, 0x00, <a class="code" href="../../d8/d38/ethercatmain_8h.html#ae02b234b1573d404b66a253d2b6c1987">EC_MAXMBX</a>);
<a name="l00687"></a>00687 }
<a name="l00688"></a>00688 <span class="comment"></span>
<a name="l00689"></a>00689 <span class="comment">/** Check if IN mailbox of slave is empty.</span>
<a name="l00690"></a>00690 <span class="comment"> * @param[in] slave   = Slave number</span>
<a name="l00691"></a>00691 <span class="comment"> * @param[in] timeout = Timeout in us</span>
<a name="l00692"></a>00692 <span class="comment"> * @return &gt;0 is success</span>
<a name="l00693"></a>00693 <span class="comment"> */</span>
<a name="l00694"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a78a07c2b50526e0f99334f7d2782264f">00694</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a78a07c2b50526e0f99334f7d2782264f" title="Check if IN mailbox of slave is empty.">ec_mbxempty</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <span class="keywordtype">int</span> timeout)
<a name="l00695"></a>00695 {
<a name="l00696"></a>00696     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> configadr;
<a name="l00697"></a>00697     <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> SMstat;
<a name="l00698"></a>00698   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a>;
<a name="l00699"></a>00699   <span class="keyword">struct </span>timeval tv1, tv2, tve;
<a name="l00700"></a>00700   
<a name="l00701"></a>00701   gettimeofday(&amp;tv1, 0);
<a name="l00702"></a>00702   tv2.tv_sec = 0;
<a name="l00703"></a>00703   tv2.tv_usec = timeout;
<a name="l00704"></a>00704   timeradd(&amp;tv1, &amp;tv2, &amp;tve);
<a name="l00705"></a>00705     configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>;
<a name="l00706"></a>00706     <span class="keywordflow">do</span>
<a name="l00707"></a>00707     {     
<a name="l00708"></a>00708         wkc = <a class="code" href="../../d5/d74/ethercatbase_8c.html#aac2dc2b5a39ace0793473ab89bb56c7d" title="FPRD &amp;quot;configured address read&amp;quot; primitive.">ec_FPRD</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a4adcd0b15e85c06e08110c149023e775">ECT_REG_SM0STAT</a>, <span class="keyword">sizeof</span>(SMstat), &amp;SMstat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l00709"></a>00709       SMstat = etohs(SMstat);
<a name="l00710"></a>00710       <span class="keywordflow">if</span> (((SMstat &amp; 0x08) != 0) &amp;&amp; (timeout &gt; <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a>)) usleep(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a>);
<a name="l00711"></a>00711       gettimeofday(&amp;tv2, 0);
<a name="l00712"></a>00712     } 
<a name="l00713"></a>00713     <span class="keywordflow">while</span> (((wkc &lt;= 0) || ((SMstat &amp; 0x08) != 0)) &amp;&amp; timercmp(&amp;tv2, &amp;tve, &lt;));
<a name="l00714"></a>00714   <span class="keywordflow">if</span> ((wkc &gt; 0) &amp;&amp; ((SMstat &amp; 0x08) == 0)) <span class="keywordflow">return</span> 1;
<a name="l00715"></a>00715   <span class="keywordflow">return</span> 0;
<a name="l00716"></a>00716 }
<a name="l00717"></a>00717   <span class="comment"></span>
<a name="l00718"></a>00718 <span class="comment">/** Write IN mailbox to slave.</span>
<a name="l00719"></a>00719 <span class="comment"> * @param[in] slave   = Slave number</span>
<a name="l00720"></a>00720 <span class="comment"> * @param[out] mbx      = Mailbox data</span>
<a name="l00721"></a>00721 <span class="comment"> * @param[in] timeout = Timeout in us</span>
<a name="l00722"></a>00722 <span class="comment"> * @return Work counter (&gt;0 is success)</span>
<a name="l00723"></a>00723 <span class="comment"> */</span>
<a name="l00724"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a575bb6105662ad54fe55c47fc72075c4">00724</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a575bb6105662ad54fe55c47fc72075c4" title="Write IN mailbox to slave.">ec_mbxsend</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>,<a class="code" href="../../d8/d38/ethercatmain_8h.html#ac62bb7429de1cb16707a415b240e590d" title="mailbox buffer array">ec_mbxbuft</a> *mbx, <span class="keywordtype">int</span> timeout)
<a name="l00725"></a>00725 {
<a name="l00726"></a>00726   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> mbxwo,mbxl,configadr;
<a name="l00727"></a>00727   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a>;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729   wkc = 0;
<a name="l00730"></a>00730   configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>;
<a name="l00731"></a>00731   mbxl = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#a7fb4df087f429b1adc44fd370efbc69e" title="length of write mailbox in bytes, if no mailbox then 0">mbx_l</a>;
<a name="l00732"></a>00732   <span class="keywordflow">if</span> (mbxl &gt; 0)
<a name="l00733"></a>00733   {
<a name="l00734"></a>00734     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a78a07c2b50526e0f99334f7d2782264f" title="Check if IN mailbox of slave is empty.">ec_mbxempty</a>(slave, timeout))
<a name="l00735"></a>00735     {
<a name="l00736"></a>00736       mbxwo = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#a767bfc34a96f5a5e8f0d4a79cea5973c" title="mailbox write offset">mbx_wo</a>;
<a name="l00737"></a>00737       <span class="comment">/* write slave in mailbox */</span>
<a name="l00738"></a>00738       wkc = <a class="code" href="../../d5/d74/ethercatbase_8c.html#aa2fe58363a824f15838718ee31f11ffc" title="FPWR &amp;quot;configured address write&amp;quot; primitive.">ec_FPWR</a>(configadr, mbxwo, mbxl, mbx, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);  
<a name="l00739"></a>00739     }
<a name="l00740"></a>00740     <span class="keywordflow">else</span> 
<a name="l00741"></a>00741       wkc = 0;
<a name="l00742"></a>00742   }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744   <span class="keywordflow">return</span> wkc;
<a name="l00745"></a>00745 }
<a name="l00746"></a>00746 <span class="comment"></span>
<a name="l00747"></a>00747 <span class="comment">/** Read OUT mailbox from slave.</span>
<a name="l00748"></a>00748 <span class="comment"> * Supports Mailbox Link Layer with repeat requests.</span>
<a name="l00749"></a>00749 <span class="comment"> * @param[in] slave   = Slave number</span>
<a name="l00750"></a>00750 <span class="comment"> * @param[out] mbx      = Mailbox data</span>
<a name="l00751"></a>00751 <span class="comment"> * @param[in] timeout = Timeout in us</span>
<a name="l00752"></a>00752 <span class="comment"> * @return Work counter (&gt;0 is success)</span>
<a name="l00753"></a>00753 <span class="comment"> */</span>
<a name="l00754"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a7c1a13c5372ba1b38c9d04085c191e73">00754</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a7c1a13c5372ba1b38c9d04085c191e73" title="Read OUT mailbox from slave.">ec_mbxreceive</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <a class="code" href="../../d8/d38/ethercatmain_8h.html#ac62bb7429de1cb16707a415b240e590d" title="mailbox buffer array">ec_mbxbuft</a> *mbx, <span class="keywordtype">int</span> timeout)
<a name="l00755"></a>00755 {
<a name="l00756"></a>00756     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> mbxro,mbxl,configadr;
<a name="l00757"></a>00757   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a>=0;
<a name="l00758"></a>00758   <span class="keywordtype">int</span> wkc2;
<a name="l00759"></a>00759     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> SMstat;
<a name="l00760"></a>00760   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> SMcontr;
<a name="l00761"></a>00761   <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">ec_mbxheadert</a> *mbxh;
<a name="l00762"></a>00762     <a class="code" href="../../d2/d06/structec__emcyt.html" title="emergency request structure">ec_emcyt</a> *EMp;
<a name="l00763"></a>00763   <span class="keyword">struct </span>timeval mtv1, mtv2, mtve;
<a name="l00764"></a>00764   
<a name="l00765"></a>00765   configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>;
<a name="l00766"></a>00766   mbxl = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#a2d8db0ad1a181c515e9fcd0c55754d16" title="length of read mailbox in bytes">mbx_rl</a>;
<a name="l00767"></a>00767     <span class="keywordflow">if</span> (mbxl &gt; 0)
<a name="l00768"></a>00768     {
<a name="l00769"></a>00769     gettimeofday(&amp;mtv1, 0);
<a name="l00770"></a>00770     mtv2.tv_sec = 0;
<a name="l00771"></a>00771     mtv2.tv_usec = timeout;
<a name="l00772"></a>00772     timeradd(&amp;mtv1, &amp;mtv2, &amp;mtve);
<a name="l00773"></a>00773       wkc = 0;
<a name="l00774"></a>00774       <span class="keywordflow">do</span> <span class="comment">/* wait for read mailbox available */</span>
<a name="l00775"></a>00775     {
<a name="l00776"></a>00776         wkc = <a class="code" href="../../d5/d74/ethercatbase_8c.html#aac2dc2b5a39ace0793473ab89bb56c7d" title="FPRD &amp;quot;configured address read&amp;quot; primitive.">ec_FPRD</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a35b5005efb1ce054c6113964c5f339d7">ECT_REG_SM1STAT</a>, <span class="keyword">sizeof</span>(SMstat), &amp;SMstat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l00777"></a>00777       SMstat = etohs(SMstat);
<a name="l00778"></a>00778       <span class="keywordflow">if</span> (((SMstat &amp; 0x08) == 0) &amp;&amp; (timeout &gt; <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a>))
<a name="l00779"></a>00779         usleep(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a>);
<a name="l00780"></a>00780       gettimeofday(&amp;mtv2, 0);
<a name="l00781"></a>00781       }
<a name="l00782"></a>00782     <span class="keywordflow">while</span> (((wkc &lt;= 0) || ((SMstat &amp; 0x08) == 0)) &amp;&amp; timercmp(&amp;mtv2, &amp;mtve, &lt;));
<a name="l00783"></a>00783 
<a name="l00784"></a>00784       <span class="keywordflow">if</span> ((wkc &gt; 0) &amp;&amp; ((SMstat &amp; 0x08) &gt; 0)) <span class="comment">/* read mailbox available ? */</span>
<a name="l00785"></a>00785       {
<a name="l00786"></a>00786         mbxro = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#a32b793aaa2c9fa6366767557715f7b73" title="mailbox read offset">mbx_ro</a>;
<a name="l00787"></a>00787       mbxh = (<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">ec_mbxheadert</a> *)mbx;
<a name="l00788"></a>00788       <span class="keywordflow">do</span>
<a name="l00789"></a>00789       { 
<a name="l00790"></a>00790               wkc = <a class="code" href="../../d5/d74/ethercatbase_8c.html#aac2dc2b5a39ace0793473ab89bb56c7d" title="FPRD &amp;quot;configured address read&amp;quot; primitive.">ec_FPRD</a>(configadr, mbxro, mbxl, mbx, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>); <span class="comment">/* get mailbox */</span>
<a name="l00791"></a>00791 <span class="comment">/* TODO : check for mailbox error response */</span>       
<a name="l00792"></a>00792             <span class="keywordflow">if</span> ((wkc &gt; 0) &amp;&amp; ((mbxh-&gt;<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#ab391b77616c280bba967a14a9eb27288">mbxtype</a> &amp; 0x0f) == 0x03)) <span class="comment">/* CoE response? */</span>
<a name="l00793"></a>00793             {
<a name="l00794"></a>00794           EMp = (<a class="code" href="../../d2/d06/structec__emcyt.html" title="emergency request structure">ec_emcyt</a> *)mbx;
<a name="l00795"></a>00795                   <span class="keywordflow">if</span> ((etohs(EMp-&gt;<a class="code" href="../../d2/d06/structec__emcyt.html#a7b87e688c6d62fefcf017b9ec2a6accd">CANOpen</a>) &gt;&gt; 12) == 0x01) <span class="comment">/* Emergency request? */</span>
<a name="l00796"></a>00796                 {
<a name="l00797"></a>00797                     ec_mbxemergencyerror(slave, etohs(EMp-&gt;<a class="code" href="../../d2/d06/structec__emcyt.html#a742f3913a82568da85221e7f098ca4aa">ErrorCode</a>), EMp-&gt;<a class="code" href="../../d2/d06/structec__emcyt.html#a2d90b9efa5ad3153672d1a9b6264eb25">ErrorReg</a>, 
<a name="l00798"></a>00798                         EMp-&gt;<a class="code" href="../../d2/d06/structec__emcyt.html#af8d0bfc65a0650b5269153c7ab9c0c7d">bData</a>, etohs(EMp-&gt;<a class="code" href="../../d2/d06/structec__emcyt.html#a9324414d5de575c8932e611cf41064f6">w1</a>), etohs(EMp-&gt;<a class="code" href="../../d2/d06/structec__emcyt.html#a1f0207657b22ae784503d61dddb2a02f">w2</a>));
<a name="l00799"></a>00799             wkc = 0; <span class="comment">/* prevent emergency to cascade up, it is already handled. */</span>
<a name="l00800"></a>00800                   }
<a name="l00801"></a>00801             }
<a name="l00802"></a>00802         <span class="keywordflow">else</span>
<a name="l00803"></a>00803         {  
<a name="l00804"></a>00804           <span class="keywordflow">if</span> (wkc &lt;= 0) <span class="comment">/* read mailbox lost */</span>
<a name="l00805"></a>00805           {
<a name="l00806"></a>00806             SMstat ^= 0x0200; <span class="comment">/* toggle repeat request */</span>
<a name="l00807"></a>00807             SMstat = htoes(SMstat);
<a name="l00808"></a>00808             wkc2 = <a class="code" href="../../d5/d74/ethercatbase_8c.html#aa2fe58363a824f15838718ee31f11ffc" title="FPWR &amp;quot;configured address write&amp;quot; primitive.">ec_FPWR</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a35b5005efb1ce054c6113964c5f339d7">ECT_REG_SM1STAT</a>, <span class="keyword">sizeof</span>(SMstat), &amp;SMstat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l00809"></a>00809             SMstat = etohs(SMstat);
<a name="l00810"></a>00810               <span class="keywordflow">do</span> <span class="comment">/* wait for toggle ack */</span>
<a name="l00811"></a>00811             {
<a name="l00812"></a>00812                 wkc2 = <a class="code" href="../../d5/d74/ethercatbase_8c.html#aac2dc2b5a39ace0793473ab89bb56c7d" title="FPRD &amp;quot;configured address read&amp;quot; primitive.">ec_FPRD</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409abd5a7eaa424f844183e44491da3578d0">ECT_REG_SM1CONTR</a>, <span class="keyword">sizeof</span>(SMcontr), &amp;SMcontr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l00813"></a>00813               gettimeofday(&amp;mtv2, 0);
<a name="l00814"></a>00814               } <span class="keywordflow">while</span> (((wkc2 &lt;= 0) || ((SMcontr &amp; 0x02) != (<a class="code" href="../../d2/dbb/ethercattype_8h.html#a3648361de4bfc342a0a5d704b634a03a" title="Macro to get hi byte of a word.">HI_BYTE</a>(SMstat) &amp; 0x02))) &amp;&amp; timercmp(&amp;mtv2, &amp;mtve, &lt;));
<a name="l00815"></a>00815               <span class="keywordflow">do</span> <span class="comment">/* wait for read mailbox available */</span>
<a name="l00816"></a>00816             {
<a name="l00817"></a>00817                 wkc2 = <a class="code" href="../../d5/d74/ethercatbase_8c.html#aac2dc2b5a39ace0793473ab89bb56c7d" title="FPRD &amp;quot;configured address read&amp;quot; primitive.">ec_FPRD</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a35b5005efb1ce054c6113964c5f339d7">ECT_REG_SM1STAT</a>, <span class="keyword">sizeof</span>(SMstat), &amp;SMstat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l00818"></a>00818               SMstat = etohs(SMstat);
<a name="l00819"></a>00819               <span class="keywordflow">if</span> (((SMstat &amp; 0x08) == 0) &amp;&amp; (timeout &gt; <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a>)) 
<a name="l00820"></a>00820               {
<a name="l00821"></a>00821                 usleep(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a>);
<a name="l00822"></a>00822               }
<a name="l00823"></a>00823               gettimeofday(&amp;mtv2, 0);
<a name="l00824"></a>00824               } <span class="keywordflow">while</span> (((wkc2 &lt;= 0) || ((SMstat &amp; 0x08) == 0)) &amp;&amp; timercmp(&amp;mtv2, &amp;mtve, &lt;));
<a name="l00825"></a>00825           } 
<a name="l00826"></a>00826         }
<a name="l00827"></a>00827       } <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; timercmp(&amp;mtv2, &amp;mtve, &lt;)); <span class="comment">/* if WKC&lt;=0 repeat */</span>
<a name="l00828"></a>00828       }
<a name="l00829"></a>00829     <span class="keywordflow">else</span> <span class="comment">/* no read mailbox available */</span>
<a name="l00830"></a>00830         wkc = 0;
<a name="l00831"></a>00831   }
<a name="l00832"></a>00832   
<a name="l00833"></a>00833     <span class="keywordflow">return</span> wkc;
<a name="l00834"></a>00834 }
<a name="l00835"></a>00835 <span class="comment"></span>
<a name="l00836"></a>00836 <span class="comment">/** Dump complete EEPROM data from slave in buffer.</span>
<a name="l00837"></a>00837 <span class="comment"> * @param[in] slave   = Slave number</span>
<a name="l00838"></a>00838 <span class="comment"> * @param[out] esibuf   = EEPROM data buffer, make sure it is big enough.</span>
<a name="l00839"></a>00839 <span class="comment"> */</span>
<a name="l00840"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a06c13efc5cc0b881a29ff6a836046b1c">00840</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a06c13efc5cc0b881a29ff6a836046b1c" title="Dump complete EEPROM data from slave in buffer.">ec_esidump</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *esibuf, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> test)
<a name="l00841"></a>00841 {
<a name="l00842"></a>00842   <span class="keywordtype">int</span> address, incr;
<a name="l00843"></a>00843   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> configadr;
<a name="l00844"></a>00844   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a29940ae63ec06c9998bba873e25407ad">uint64</a> *p64;
<a name="l00845"></a>00845   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> *p16;
<a name="l00846"></a>00846   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a29940ae63ec06c9998bba873e25407ad">uint64</a> edat;
<a name="l00847"></a>00847   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> eectl = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#ae42d1bcef392fdd8e18b2499ab8f11ef" title="0 = eeprom to master , 1 = eeprom to PDI">eep_pdi</a>;
<a name="l00848"></a>00848 
<a name="l00849"></a>00849   <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a027bd337ebfa1d39de8a7a1f5c5287de" title="Set eeprom control to master.">ec_eeprom2master</a>(slave); <span class="comment">/* set eeprom control to master */</span>
<a name="l00850"></a>00850     configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>;
<a name="l00851"></a>00851   address = <a class="code" href="../../d2/dbb/ethercattype_8h.html#a3f4a71ab602c23ce1d5b3a7c539a444f" title="Start address SII sections in Eeprom.">ECT_SII_START</a>;
<a name="l00852"></a>00852   p16=(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a>*)esibuf;
<a name="l00853"></a>00853   <span class="keywordflow">if</span> (ec_slave[slave].eep_8byte) 
<a name="l00854"></a>00854     incr = 4; 
<a name="l00855"></a>00855   <span class="keywordflow">else</span> 
<a name="l00856"></a>00856     incr = 2;
<a name="l00857"></a>00857   <span class="keywordflow">do</span>
<a name="l00858"></a>00858   {
<a name="l00859"></a>00859     edat = <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ace89c7536b04427ffb755e77a5525855" title="Read EEPROM from slave bypassing cache.">ec_readeepromFP</a>(configadr, address, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a8684bafce6bd5ae0676fd6440a832276" title="timeout value in us for EEPROM access">EC_TIMEOUTEEP</a>);
<a name="l00860"></a>00860     p64 = (<a class="code" href="../../d2/dbb/ethercattype_8h.html#a29940ae63ec06c9998bba873e25407ad">uint64</a>*)p16;
<a name="l00861"></a>00861     *p64 = edat;
<a name="l00862"></a>00862     p16 += incr;
<a name="l00863"></a>00863     address += incr; 
<a name="l00864"></a>00864   } <span class="keywordflow">while</span> ((address &lt;= (<a class="code" href="../../d2/dbb/ethercattype_8h.html#a6e94d73c1eb1a9ff2aa0a0b3ac09409a" title="size of EEPROM cache buffer">EC_MAXEEPBUF</a> &gt;&gt; 1)) &amp;&amp; ((<a class="code" href="../../d2/dbb/ethercattype_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a>)edat != 0xffffffff));
<a name="l00865"></a>00865 
<a name="l00866"></a>00866   <span class="keywordflow">if</span> (eectl) <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ae149a6cd4a61c22efa4cf4185ffd83be" title="Set eeprom control to PDI.">ec_eeprom2pdi</a>(slave); <span class="comment">/* if eeprom control was previously pdi then restore */</span>
<a name="l00867"></a>00867 }
<a name="l00868"></a>00868 <span class="comment"></span>
<a name="l00869"></a>00869 <span class="comment">/** Read EEPROM from slave bypassing cache.</span>
<a name="l00870"></a>00870 <span class="comment"> * @param[in] slave   = Slave number</span>
<a name="l00871"></a>00871 <span class="comment"> * @param[in] eeproma   = (WORD) Address in the EEPROM</span>
<a name="l00872"></a>00872 <span class="comment"> * @param[in] timeout = Timeout in us.</span>
<a name="l00873"></a>00873 <span class="comment"> * @return EEPROM data 32bit</span>
<a name="l00874"></a>00874 <span class="comment"> */</span>
<a name="l00875"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#aacc964b3a092b666f8011717be911d35">00875</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#aacc964b3a092b666f8011717be911d35" title="Read EEPROM from slave bypassing cache.">ec_readeeprom</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> eeproma, <span class="keywordtype">int</span> timeout)
<a name="l00876"></a>00876 {
<a name="l00877"></a>00877     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> configadr;
<a name="l00878"></a>00878 
<a name="l00879"></a>00879   <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a027bd337ebfa1d39de8a7a1f5c5287de" title="Set eeprom control to master.">ec_eeprom2master</a>(slave); <span class="comment">/* set eeprom control to master */</span>
<a name="l00880"></a>00880     configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>;
<a name="l00881"></a>00881     <span class="keywordflow">return</span> (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#ace89c7536b04427ffb755e77a5525855" title="Read EEPROM from slave bypassing cache.">ec_readeepromFP</a>(configadr, eeproma, timeout));
<a name="l00882"></a>00882 }
<a name="l00883"></a>00883 <span class="comment"></span>
<a name="l00884"></a>00884 <span class="comment">/** Write EEPROM to slave bypassing cache.</span>
<a name="l00885"></a>00885 <span class="comment"> * @param[in] slave   = Slave number</span>
<a name="l00886"></a>00886 <span class="comment"> * @param[in] eeproma   = (WORD) Address in the EEPROM</span>
<a name="l00887"></a>00887 <span class="comment"> * @param[in] data    = 16bit data</span>
<a name="l00888"></a>00888 <span class="comment"> * @param[in] timeout = Timeout in us.</span>
<a name="l00889"></a>00889 <span class="comment"> * @return &gt;0 if OK</span>
<a name="l00890"></a>00890 <span class="comment"> */</span>
<a name="l00891"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#aaa333cdc5ea2ac66cf24a75855d9749b">00891</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#aaa333cdc5ea2ac66cf24a75855d9749b" title="Write EEPROM to slave bypassing cache.">ec_writeeeprom</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> eeproma, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> data, <span class="keywordtype">int</span> timeout)
<a name="l00892"></a>00892 {
<a name="l00893"></a>00893     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> configadr;
<a name="l00894"></a>00894 
<a name="l00895"></a>00895   <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a027bd337ebfa1d39de8a7a1f5c5287de" title="Set eeprom control to master.">ec_eeprom2master</a>(slave); <span class="comment">/* set eeprom control to master */</span>
<a name="l00896"></a>00896     configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>;
<a name="l00897"></a>00897     <span class="keywordflow">return</span> (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#ad4724bcbd8417e56ff2405cec44d6535" title="Write EEPROM to slave bypassing cache.">ec_writeeepromFP</a>(configadr, eeproma, data, timeout));
<a name="l00898"></a>00898 }
<a name="l00899"></a>00899 
<a name="l00900"></a>00900 <span class="comment"></span>
<a name="l00901"></a>00901 <span class="comment">/** Set eeprom control to master. Only if set to PDI.</span>
<a name="l00902"></a>00902 <span class="comment"> * @param[in] slave   = Slave number</span>
<a name="l00903"></a>00903 <span class="comment"> * @return &gt;0 if OK</span>
<a name="l00904"></a>00904 <span class="comment"> */</span>
<a name="l00905"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a027bd337ebfa1d39de8a7a1f5c5287de">00905</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a027bd337ebfa1d39de8a7a1f5c5287de" title="Set eeprom control to master.">ec_eeprom2master</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>)
<a name="l00906"></a>00906 {
<a name="l00907"></a>00907   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a> = 1, cnt = 0;
<a name="l00908"></a>00908     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> configadr;
<a name="l00909"></a>00909   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> eepctl;
<a name="l00910"></a>00910 
<a name="l00911"></a>00911   <span class="keywordflow">if</span> ( ec_slave[slave].eep_pdi )
<a name="l00912"></a>00912   {
<a name="l00913"></a>00913       configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>; 
<a name="l00914"></a>00914     eepctl = 2;
<a name="l00915"></a>00915     <span class="keywordflow">do</span>
<a name="l00916"></a>00916     {
<a name="l00917"></a>00917       wkc = <a class="code" href="../../d5/d74/ethercatbase_8c.html#aa2fe58363a824f15838718ee31f11ffc" title="FPWR &amp;quot;configured address write&amp;quot; primitive.">ec_FPWR</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a6f7eb31db1ad97ad91d1ac9e532cbc08">ECT_REG_EEPCFG</a>, <span class="keyword">sizeof</span>(eepctl), &amp;eepctl , <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>); <span class="comment">/* force Eeprom from PDI */</span>
<a name="l00918"></a>00918     }
<a name="l00919"></a>00919     <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l00920"></a>00920     eepctl = 0;
<a name="l00921"></a>00921     cnt = 0;
<a name="l00922"></a>00922     <span class="keywordflow">do</span>
<a name="l00923"></a>00923     {
<a name="l00924"></a>00924       wkc = <a class="code" href="../../d5/d74/ethercatbase_8c.html#aa2fe58363a824f15838718ee31f11ffc" title="FPWR &amp;quot;configured address write&amp;quot; primitive.">ec_FPWR</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a6f7eb31db1ad97ad91d1ac9e532cbc08">ECT_REG_EEPCFG</a>, <span class="keyword">sizeof</span>(eepctl), &amp;eepctl , <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>); <span class="comment">/* set Eeprom to master */</span>
<a name="l00925"></a>00925     }
<a name="l00926"></a>00926     <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l00927"></a>00927     ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#ae42d1bcef392fdd8e18b2499ab8f11ef" title="0 = eeprom to master , 1 = eeprom to PDI">eep_pdi</a> = 0;
<a name="l00928"></a>00928   }
<a name="l00929"></a>00929 
<a name="l00930"></a>00930   <span class="keywordflow">return</span> wkc;
<a name="l00931"></a>00931 } 
<a name="l00932"></a>00932 <span class="comment"></span>
<a name="l00933"></a>00933 <span class="comment">/** Set eeprom control to PDI. Only if set to master.</span>
<a name="l00934"></a>00934 <span class="comment"> * @param[in] slave   = Slave number</span>
<a name="l00935"></a>00935 <span class="comment"> * @return &gt;0 if OK</span>
<a name="l00936"></a>00936 <span class="comment"> */</span>
<a name="l00937"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#ae149a6cd4a61c22efa4cf4185ffd83be">00937</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ae149a6cd4a61c22efa4cf4185ffd83be" title="Set eeprom control to PDI.">ec_eeprom2pdi</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>)
<a name="l00938"></a>00938 {
<a name="l00939"></a>00939   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a> = 1, cnt = 0;
<a name="l00940"></a>00940     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> configadr;
<a name="l00941"></a>00941   <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> eepctl;
<a name="l00942"></a>00942 
<a name="l00943"></a>00943   <span class="keywordflow">if</span> ( !ec_slave[slave].eep_pdi )
<a name="l00944"></a>00944   {
<a name="l00945"></a>00945       configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>; 
<a name="l00946"></a>00946     eepctl = 1;
<a name="l00947"></a>00947     <span class="keywordflow">do</span>
<a name="l00948"></a>00948     {
<a name="l00949"></a>00949       wkc = <a class="code" href="../../d5/d74/ethercatbase_8c.html#aa2fe58363a824f15838718ee31f11ffc" title="FPWR &amp;quot;configured address write&amp;quot; primitive.">ec_FPWR</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a6f7eb31db1ad97ad91d1ac9e532cbc08">ECT_REG_EEPCFG</a>, <span class="keyword">sizeof</span>(eepctl), &amp;eepctl , <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>); <span class="comment">/* set Eeprom to PDI */</span>
<a name="l00950"></a>00950     }
<a name="l00951"></a>00951     <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l00952"></a>00952     ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#ae42d1bcef392fdd8e18b2499ab8f11ef" title="0 = eeprom to master , 1 = eeprom to PDI">eep_pdi</a> = 1;
<a name="l00953"></a>00953   }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955   <span class="keywordflow">return</span> wkc;
<a name="l00956"></a>00956 } 
<a name="l00957"></a>00957 
<a name="l00958"></a><a class="code" href="../../d3/d6b/ethercatmain_8c.html#af4b40499a69dd20db5aa8da081c7274f">00958</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#af4b40499a69dd20db5aa8da081c7274f">ec_eeprom_waitnotbusyAP</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> aiadr,<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> *estat, <span class="keywordtype">int</span> timeout)
<a name="l00959"></a>00959 {
<a name="l00960"></a>00960   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a>, cnt = 0, retval = 0;
<a name="l00961"></a>00961   <span class="keyword">struct </span>timeval tv1, tv2, tve;
<a name="l00962"></a>00962   
<a name="l00963"></a>00963   gettimeofday(&amp;tv1, 0);
<a name="l00964"></a>00964   tv2.tv_sec = 0;
<a name="l00965"></a>00965   tv2.tv_usec = timeout;
<a name="l00966"></a>00966   timeradd(&amp;tv1, &amp;tv2, &amp;tve);
<a name="l00967"></a>00967   <span class="keywordflow">do</span>
<a name="l00968"></a>00968   {
<a name="l00969"></a>00969     <span class="keywordflow">if</span> (cnt++) usleep(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a>);
<a name="l00970"></a>00970     wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#a80f6087e11fc1a42832f7c7872122308" title="APRD &amp;quot;auto increment address read&amp;quot; primitive.">ec_APRD</a>(aiadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409abea30cd11205943adc68f20f3ba878a0">ECT_REG_EEPSTAT</a>, <span class="keyword">sizeof</span>(*estat), estat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l00971"></a>00971     *estat = etohs(*estat);
<a name="l00972"></a>00972     gettimeofday(&amp;tv2, 0);
<a name="l00973"></a>00973   }
<a name="l00974"></a>00974   <span class="keywordflow">while</span> (((wkc &lt;= 0) || ((*estat &amp; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ad84fdcfc25cec6820c3ade24359c26e9" title="EEprom state machine busy flag.">EC_ESTAT_BUSY</a>) &gt; 0)) &amp;&amp; (timercmp(&amp;tv2, &amp;tve, &lt;))); <span class="comment">/* wait for eeprom ready */</span>
<a name="l00975"></a>00975   <span class="keywordflow">if</span> ((*estat &amp; EC_ESTAT_BUSY) == 0) retval = 1;
<a name="l00976"></a>00976   <span class="keywordflow">return</span> retval;
<a name="l00977"></a>00977 }
<a name="l00978"></a>00978 <span class="comment"></span>
<a name="l00979"></a>00979 <span class="comment">/** Read EEPROM from slave bypassing cache. APRD method.</span>
<a name="l00980"></a>00980 <span class="comment"> * @param[in] aiadr   = auto increment address of slave</span>
<a name="l00981"></a>00981 <span class="comment"> * @param[in] eeproma   = (WORD) Address in the EEPROM</span>
<a name="l00982"></a>00982 <span class="comment"> * @param[in] timeout = Timeout in us.</span>
<a name="l00983"></a>00983 <span class="comment"> * @return EEPROM data 64bit or 32bit</span>
<a name="l00984"></a>00984 <span class="comment"> */</span>
<a name="l00985"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#ad1f3c620e76b3395d7deccc23ef0f8c5">00985</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a29940ae63ec06c9998bba873e25407ad">uint64</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ad1f3c620e76b3395d7deccc23ef0f8c5" title="Read EEPROM from slave bypassing cache.">ec_readeepromAP</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> aiadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> eeproma, <span class="keywordtype">int</span> timeout)
<a name="l00986"></a>00986 {
<a name="l00987"></a>00987     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> estat;
<a name="l00988"></a>00988     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> edat32;
<a name="l00989"></a>00989   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a29940ae63ec06c9998bba873e25407ad">uint64</a> edat64;
<a name="l00990"></a>00990     <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">ec_eepromt</a> ed;
<a name="l00991"></a>00991   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a>, cnt, nackcnt = 0;
<a name="l00992"></a>00992   <span class="keyword">struct </span>timeval tv1, tv2, tve;
<a name="l00993"></a>00993   
<a name="l00994"></a>00994   gettimeofday(&amp;tv1, 0);
<a name="l00995"></a>00995   tv2.tv_sec = 0;
<a name="l00996"></a>00996   tv2.tv_usec = timeout;
<a name="l00997"></a>00997   timeradd(&amp;tv1, &amp;tv2, &amp;tve);
<a name="l00998"></a>00998   edat64 = 0;
<a name="l00999"></a>00999   edat32 = 0;
<a name="l01000"></a>01000   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#af4b40499a69dd20db5aa8da081c7274f">ec_eeprom_waitnotbusyAP</a>(aiadr, &amp;estat, timeout))
<a name="l01001"></a>01001   {
<a name="l01002"></a>01002     <span class="keywordflow">if</span> (estat &amp; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ab9419abfbf52a4003015c51b73bb15e2" title="EEprom state machine error flag mask.">EC_ESTAT_EMASK</a>) <span class="comment">/* error bits are set */</span>
<a name="l01003"></a>01003     {
<a name="l01004"></a>01004       estat = htoes(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a2dd0ee42096f9789813a172b15ef8109ae3f82aa9fbf496dc48b0e185e331f1fa" title="No operation.">EC_ECMD_NOP</a>); <span class="comment">/* clear error bits */</span>
<a name="l01005"></a>01005       wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#a02a1741d276571009e46fbe39e9f729f" title="APWR &amp;quot;auto increment address write&amp;quot; primitive.">ec_APWR</a>(aiadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a36c8c891a4dc0801621d7e65612a38d5">ECT_REG_EEPCTL</a>, <span class="keyword">sizeof</span>(estat), &amp;estat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01006"></a>01006     }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008     <span class="keywordflow">do</span>
<a name="l01009"></a>01009     {
<a name="l01010"></a>01010       ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#a5307909961ad21d67d4c6580552f5bbe">comm</a> = htoes(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a2dd0ee42096f9789813a172b15ef8109a3463bc22acea07dadd859c440ea9c067" title="Read.">EC_ECMD_READ</a>);
<a name="l01011"></a>01011       ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#acf380647fbea1a0daaa9c8759927c966">addr</a> = htoes(eeproma);
<a name="l01012"></a>01012       ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#af0b786050ce4a35f23b36ec4124bcb58">d2</a>   = 0x0000;
<a name="l01013"></a>01013       cnt = 0;
<a name="l01014"></a>01014       <span class="keywordflow">do</span>
<a name="l01015"></a>01015         wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#a02a1741d276571009e46fbe39e9f729f" title="APWR &amp;quot;auto increment address write&amp;quot; primitive.">ec_APWR</a>(aiadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a36c8c891a4dc0801621d7e65612a38d5">ECT_REG_EEPCTL</a>, <span class="keyword">sizeof</span>(ed), &amp;ed, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01016"></a>01016       <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l01017"></a>01017       <span class="keywordflow">if</span> (wkc)
<a name="l01018"></a>01018       {
<a name="l01019"></a>01019         usleep(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a>);
<a name="l01020"></a>01020         estat = 0x0000;
<a name="l01021"></a>01021         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#af4b40499a69dd20db5aa8da081c7274f">ec_eeprom_waitnotbusyAP</a>(aiadr, &amp;estat, timeout))
<a name="l01022"></a>01022         { 
<a name="l01023"></a>01023           <span class="keywordflow">if</span> (estat &amp; <a class="code" href="../../d2/dbb/ethercattype_8h.html#a8386909d61a1353ca45e918ca929416a" title="EEprom state machine error acknowledge.">EC_ESTAT_NACK</a>)
<a name="l01024"></a>01024           {
<a name="l01025"></a>01025             nackcnt++;
<a name="l01026"></a>01026             usleep(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a> * 5);
<a name="l01027"></a>01027           }
<a name="l01028"></a>01028           <span class="keywordflow">else</span>
<a name="l01029"></a>01029           {
<a name="l01030"></a>01030             nackcnt = 0;
<a name="l01031"></a>01031             <span class="keywordflow">if</span> (estat &amp; <a class="code" href="../../d2/dbb/ethercattype_8h.html#a6a0a67b499eddc5c96fbc7f3fb09b4bd" title="EEprom state machine read size.">EC_ESTAT_R64</a>)
<a name="l01032"></a>01032             {
<a name="l01033"></a>01033               cnt = 0;
<a name="l01034"></a>01034               <span class="keywordflow">do</span>
<a name="l01035"></a>01035                 wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#a80f6087e11fc1a42832f7c7872122308" title="APRD &amp;quot;auto increment address read&amp;quot; primitive.">ec_APRD</a>(aiadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a39cb96c8f01f5a283bbb81e2149731dd">ECT_REG_EEPDAT</a>, <span class="keyword">sizeof</span>(edat64), &amp;edat64, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01036"></a>01036               <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l01037"></a>01037             }
<a name="l01038"></a>01038             <span class="keywordflow">else</span>
<a name="l01039"></a>01039             { 
<a name="l01040"></a>01040               cnt = 0;
<a name="l01041"></a>01041               <span class="keywordflow">do</span>
<a name="l01042"></a>01042                 wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#a80f6087e11fc1a42832f7c7872122308" title="APRD &amp;quot;auto increment address read&amp;quot; primitive.">ec_APRD</a>(aiadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a39cb96c8f01f5a283bbb81e2149731dd">ECT_REG_EEPDAT</a>, <span class="keyword">sizeof</span>(edat32), &amp;edat32, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01043"></a>01043               <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l01044"></a>01044               edat64=(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a29940ae63ec06c9998bba873e25407ad">uint64</a>)edat32;
<a name="l01045"></a>01045             }
<a name="l01046"></a>01046           }
<a name="l01047"></a>01047         } 
<a name="l01048"></a>01048       }     
<a name="l01049"></a>01049     }
<a name="l01050"></a>01050     <span class="keywordflow">while</span> ((nackcnt &gt; 0) &amp;&amp; (nackcnt &lt; 3));
<a name="l01051"></a>01051   }
<a name="l01052"></a>01052     <span class="keywordflow">return</span> edat64;
<a name="l01053"></a>01053 }
<a name="l01054"></a>01054 <span class="comment"></span>
<a name="l01055"></a>01055 <span class="comment">/** Write EEPROM to slave bypassing cache. APWR method.</span>
<a name="l01056"></a>01056 <span class="comment"> * @param[in] aiadr   = configured address of slave</span>
<a name="l01057"></a>01057 <span class="comment"> * @param[in] eeproma   = (WORD) Address in the EEPROM</span>
<a name="l01058"></a>01058 <span class="comment"> * @param[in] data    = 16bit data</span>
<a name="l01059"></a>01059 <span class="comment"> * @param[in] timeout = Timeout in us.</span>
<a name="l01060"></a>01060 <span class="comment"> * @return &gt;0 if OK</span>
<a name="l01061"></a>01061 <span class="comment"> */</span>
<a name="l01062"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a968dc550dde8340fbe80032f81662427">01062</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a968dc550dde8340fbe80032f81662427" title="Write EEPROM to slave bypassing cache.">ec_writeeepromAP</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> aiadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> eeproma, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> data, <span class="keywordtype">int</span> timeout)
<a name="l01063"></a>01063 {
<a name="l01064"></a>01064     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> estat;
<a name="l01065"></a>01065     <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">ec_eepromt</a> ed;
<a name="l01066"></a>01066   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a>, rval = 0, cnt = 0, nackcnt = 0;
<a name="l01067"></a>01067   <span class="keyword">struct </span>timeval tv1, tv2, tve;
<a name="l01068"></a>01068 
<a name="l01069"></a>01069   gettimeofday(&amp;tv1, 0);
<a name="l01070"></a>01070   tv2.tv_sec = 0;
<a name="l01071"></a>01071   tv2.tv_usec = timeout;
<a name="l01072"></a>01072   timeradd(&amp;tv1, &amp;tv2, &amp;tve);
<a name="l01073"></a>01073   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#af4b40499a69dd20db5aa8da081c7274f">ec_eeprom_waitnotbusyAP</a>(aiadr, &amp;estat, timeout))
<a name="l01074"></a>01074   {
<a name="l01075"></a>01075     <span class="keywordflow">if</span> (estat &amp; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ab9419abfbf52a4003015c51b73bb15e2" title="EEprom state machine error flag mask.">EC_ESTAT_EMASK</a>) <span class="comment">/* error bits are set */</span>
<a name="l01076"></a>01076     {
<a name="l01077"></a>01077       estat = htoes(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a2dd0ee42096f9789813a172b15ef8109ae3f82aa9fbf496dc48b0e185e331f1fa" title="No operation.">EC_ECMD_NOP</a>); <span class="comment">/* clear error bits */</span>
<a name="l01078"></a>01078       wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#a02a1741d276571009e46fbe39e9f729f" title="APWR &amp;quot;auto increment address write&amp;quot; primitive.">ec_APWR</a>(aiadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a36c8c891a4dc0801621d7e65612a38d5">ECT_REG_EEPCTL</a>, <span class="keyword">sizeof</span>(estat), &amp;estat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01079"></a>01079     }
<a name="l01080"></a>01080     <span class="keywordflow">do</span>
<a name="l01081"></a>01081     {
<a name="l01082"></a>01082       cnt = 0;
<a name="l01083"></a>01083       <span class="keywordflow">do</span>
<a name="l01084"></a>01084         wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#a02a1741d276571009e46fbe39e9f729f" title="APWR &amp;quot;auto increment address write&amp;quot; primitive.">ec_APWR</a>(aiadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a39cb96c8f01f5a283bbb81e2149731dd">ECT_REG_EEPDAT</a>, <span class="keyword">sizeof</span>(data), &amp;data, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01085"></a>01085       <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l01086"></a>01086 
<a name="l01087"></a>01087       ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#a5307909961ad21d67d4c6580552f5bbe">comm</a> = <a class="code" href="../../d2/dbb/ethercattype_8h.html#a2dd0ee42096f9789813a172b15ef8109a8d55b9bde1dcf526efb24ee837aafe68" title="Write.">EC_ECMD_WRITE</a>;
<a name="l01088"></a>01088       ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#acf380647fbea1a0daaa9c8759927c966">addr</a> = eeproma;
<a name="l01089"></a>01089       ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#af0b786050ce4a35f23b36ec4124bcb58">d2</a>   = 0x0000;
<a name="l01090"></a>01090       cnt = 0;
<a name="l01091"></a>01091       <span class="keywordflow">do</span>
<a name="l01092"></a>01092         wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#a02a1741d276571009e46fbe39e9f729f" title="APWR &amp;quot;auto increment address write&amp;quot; primitive.">ec_APWR</a>(aiadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a36c8c891a4dc0801621d7e65612a38d5">ECT_REG_EEPCTL</a>, <span class="keyword">sizeof</span>(ed), &amp;ed, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01093"></a>01093       <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l01094"></a>01094       <span class="keywordflow">if</span> (wkc)
<a name="l01095"></a>01095       {
<a name="l01096"></a>01096         usleep(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a> * 2);
<a name="l01097"></a>01097         estat = 0x0000;
<a name="l01098"></a>01098         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#af4b40499a69dd20db5aa8da081c7274f">ec_eeprom_waitnotbusyAP</a>(aiadr, &amp;estat, timeout))
<a name="l01099"></a>01099         { 
<a name="l01100"></a>01100           <span class="keywordflow">if</span> (estat &amp; <a class="code" href="../../d2/dbb/ethercattype_8h.html#a8386909d61a1353ca45e918ca929416a" title="EEprom state machine error acknowledge.">EC_ESTAT_NACK</a>)
<a name="l01101"></a>01101           {
<a name="l01102"></a>01102             nackcnt++;
<a name="l01103"></a>01103             usleep(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a> * 5);
<a name="l01104"></a>01104           }
<a name="l01105"></a>01105           <span class="keywordflow">else</span>
<a name="l01106"></a>01106           {
<a name="l01107"></a>01107             nackcnt = 0;
<a name="l01108"></a>01108             rval = 1;
<a name="l01109"></a>01109           }
<a name="l01110"></a>01110         }
<a name="l01111"></a>01111       }
<a name="l01112"></a>01112 
<a name="l01113"></a>01113     }
<a name="l01114"></a>01114     <span class="keywordflow">while</span> ((nackcnt &gt; 0) &amp;&amp; (nackcnt &lt; 3));   
<a name="l01115"></a>01115   }
<a name="l01116"></a>01116     <span class="keywordflow">return</span> rval;
<a name="l01117"></a>01117 }
<a name="l01118"></a>01118 
<a name="l01119"></a><a class="code" href="../../d3/d6b/ethercatmain_8c.html#a683af1ff758441cb62905cb041e428a1">01119</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a683af1ff758441cb62905cb041e428a1">ec_eeprom_waitnotbusyFP</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> configadr,<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> *estat, <span class="keywordtype">int</span> timeout)
<a name="l01120"></a>01120 {
<a name="l01121"></a>01121   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a>, cnt = 0, retval = 0;
<a name="l01122"></a>01122   <span class="keyword">struct </span>timeval tv1, tv2, tve;
<a name="l01123"></a>01123   
<a name="l01124"></a>01124   gettimeofday(&amp;tv1, 0);
<a name="l01125"></a>01125   tv2.tv_sec = 0;
<a name="l01126"></a>01126   tv2.tv_usec = timeout;
<a name="l01127"></a>01127   timeradd(&amp;tv1, &amp;tv2, &amp;tve);
<a name="l01128"></a>01128   <span class="keywordflow">do</span>
<a name="l01129"></a>01129   {
<a name="l01130"></a>01130     <span class="keywordflow">if</span> (cnt++) usleep(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a>);
<a name="l01131"></a>01131     wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#aac2dc2b5a39ace0793473ab89bb56c7d" title="FPRD &amp;quot;configured address read&amp;quot; primitive.">ec_FPRD</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409abea30cd11205943adc68f20f3ba878a0">ECT_REG_EEPSTAT</a>, <span class="keyword">sizeof</span>(*estat), estat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01132"></a>01132     *estat = etohs(*estat);
<a name="l01133"></a>01133     gettimeofday(&amp;tv2, 0);
<a name="l01134"></a>01134   }
<a name="l01135"></a>01135   <span class="keywordflow">while</span> (((wkc &lt;= 0) || ((*estat &amp; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ad84fdcfc25cec6820c3ade24359c26e9" title="EEprom state machine busy flag.">EC_ESTAT_BUSY</a>) &gt; 0)) &amp;&amp; (timercmp(&amp;tv2, &amp;tve, &lt;))); <span class="comment">/* wait for eeprom ready */</span>
<a name="l01136"></a>01136   <span class="keywordflow">if</span> ((*estat &amp; EC_ESTAT_BUSY) == 0) retval = 1;
<a name="l01137"></a>01137   <span class="keywordflow">return</span> retval;
<a name="l01138"></a>01138 }
<a name="l01139"></a>01139 <span class="comment"></span>
<a name="l01140"></a>01140 <span class="comment">/** Read EEPROM from slave bypassing cache. FPRD method.</span>
<a name="l01141"></a>01141 <span class="comment"> * @param[in] configadr = configured address of slave</span>
<a name="l01142"></a>01142 <span class="comment"> * @param[in] eeproma   = (WORD) Address in the EEPROM</span>
<a name="l01143"></a>01143 <span class="comment"> * @param[in] timeout = Timeout in us.</span>
<a name="l01144"></a>01144 <span class="comment"> * @return EEPROM data 64bit or 32bit</span>
<a name="l01145"></a>01145 <span class="comment"> */</span>
<a name="l01146"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#ace89c7536b04427ffb755e77a5525855">01146</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a29940ae63ec06c9998bba873e25407ad">uint64</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ace89c7536b04427ffb755e77a5525855" title="Read EEPROM from slave bypassing cache.">ec_readeepromFP</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> eeproma, <span class="keywordtype">int</span> timeout)
<a name="l01147"></a>01147 {
<a name="l01148"></a>01148     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> estat;
<a name="l01149"></a>01149     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> edat32;
<a name="l01150"></a>01150   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a29940ae63ec06c9998bba873e25407ad">uint64</a> edat64;
<a name="l01151"></a>01151     <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">ec_eepromt</a> ed;
<a name="l01152"></a>01152   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a>, cnt, nackcnt = 0;
<a name="l01153"></a>01153   <span class="keyword">struct </span>timeval tv1, tv2, tve;
<a name="l01154"></a>01154   
<a name="l01155"></a>01155   gettimeofday(&amp;tv1, 0);
<a name="l01156"></a>01156   tv2.tv_sec = 0;
<a name="l01157"></a>01157   tv2.tv_usec = timeout;
<a name="l01158"></a>01158   timeradd(&amp;tv1, &amp;tv2, &amp;tve);
<a name="l01159"></a>01159   edat64 = 0;
<a name="l01160"></a>01160   edat32 = 0;
<a name="l01161"></a>01161   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a683af1ff758441cb62905cb041e428a1">ec_eeprom_waitnotbusyFP</a>(configadr, &amp;estat, timeout))
<a name="l01162"></a>01162   {
<a name="l01163"></a>01163     <span class="keywordflow">if</span> (estat &amp; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ab9419abfbf52a4003015c51b73bb15e2" title="EEprom state machine error flag mask.">EC_ESTAT_EMASK</a>) <span class="comment">/* error bits are set */</span>
<a name="l01164"></a>01164     {
<a name="l01165"></a>01165       estat = htoes(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a2dd0ee42096f9789813a172b15ef8109ae3f82aa9fbf496dc48b0e185e331f1fa" title="No operation.">EC_ECMD_NOP</a>); <span class="comment">/* clear error bits */</span>
<a name="l01166"></a>01166       wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#aa2fe58363a824f15838718ee31f11ffc" title="FPWR &amp;quot;configured address write&amp;quot; primitive.">ec_FPWR</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a36c8c891a4dc0801621d7e65612a38d5">ECT_REG_EEPCTL</a>, <span class="keyword">sizeof</span>(estat), &amp;estat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01167"></a>01167     }
<a name="l01168"></a>01168 
<a name="l01169"></a>01169     <span class="keywordflow">do</span>
<a name="l01170"></a>01170     {
<a name="l01171"></a>01171       ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#a5307909961ad21d67d4c6580552f5bbe">comm</a> = htoes(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a2dd0ee42096f9789813a172b15ef8109a3463bc22acea07dadd859c440ea9c067" title="Read.">EC_ECMD_READ</a>);
<a name="l01172"></a>01172       ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#acf380647fbea1a0daaa9c8759927c966">addr</a> = htoes(eeproma);
<a name="l01173"></a>01173       ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#af0b786050ce4a35f23b36ec4124bcb58">d2</a>   = 0x0000;
<a name="l01174"></a>01174       cnt = 0;
<a name="l01175"></a>01175       <span class="keywordflow">do</span>
<a name="l01176"></a>01176         wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#aa2fe58363a824f15838718ee31f11ffc" title="FPWR &amp;quot;configured address write&amp;quot; primitive.">ec_FPWR</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a36c8c891a4dc0801621d7e65612a38d5">ECT_REG_EEPCTL</a>, <span class="keyword">sizeof</span>(ed), &amp;ed, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01177"></a>01177       <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l01178"></a>01178       <span class="keywordflow">if</span> (wkc)
<a name="l01179"></a>01179       {
<a name="l01180"></a>01180         usleep(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a>);
<a name="l01181"></a>01181         estat = 0x0000;
<a name="l01182"></a>01182         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a683af1ff758441cb62905cb041e428a1">ec_eeprom_waitnotbusyFP</a>(configadr, &amp;estat, timeout))
<a name="l01183"></a>01183         { 
<a name="l01184"></a>01184           <span class="keywordflow">if</span> (estat &amp; <a class="code" href="../../d2/dbb/ethercattype_8h.html#a8386909d61a1353ca45e918ca929416a" title="EEprom state machine error acknowledge.">EC_ESTAT_NACK</a>)
<a name="l01185"></a>01185           {
<a name="l01186"></a>01186             nackcnt++;
<a name="l01187"></a>01187             usleep(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a> * 5);
<a name="l01188"></a>01188           }
<a name="l01189"></a>01189           <span class="keywordflow">else</span>
<a name="l01190"></a>01190           {
<a name="l01191"></a>01191             nackcnt = 0;
<a name="l01192"></a>01192             <span class="keywordflow">if</span> (estat &amp; <a class="code" href="../../d2/dbb/ethercattype_8h.html#a6a0a67b499eddc5c96fbc7f3fb09b4bd" title="EEprom state machine read size.">EC_ESTAT_R64</a>)
<a name="l01193"></a>01193             {
<a name="l01194"></a>01194               cnt = 0;
<a name="l01195"></a>01195               <span class="keywordflow">do</span>
<a name="l01196"></a>01196                 wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#aac2dc2b5a39ace0793473ab89bb56c7d" title="FPRD &amp;quot;configured address read&amp;quot; primitive.">ec_FPRD</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a39cb96c8f01f5a283bbb81e2149731dd">ECT_REG_EEPDAT</a>, <span class="keyword">sizeof</span>(edat64), &amp;edat64, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01197"></a>01197               <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l01198"></a>01198             }
<a name="l01199"></a>01199             <span class="keywordflow">else</span>
<a name="l01200"></a>01200             { 
<a name="l01201"></a>01201               cnt = 0;
<a name="l01202"></a>01202               <span class="keywordflow">do</span>
<a name="l01203"></a>01203                 wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#aac2dc2b5a39ace0793473ab89bb56c7d" title="FPRD &amp;quot;configured address read&amp;quot; primitive.">ec_FPRD</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a39cb96c8f01f5a283bbb81e2149731dd">ECT_REG_EEPDAT</a>, <span class="keyword">sizeof</span>(edat32), &amp;edat32, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01204"></a>01204               <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l01205"></a>01205               edat64=(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a29940ae63ec06c9998bba873e25407ad">uint64</a>)edat32;
<a name="l01206"></a>01206             }
<a name="l01207"></a>01207           }
<a name="l01208"></a>01208         } 
<a name="l01209"></a>01209       }     
<a name="l01210"></a>01210     }
<a name="l01211"></a>01211     <span class="keywordflow">while</span> ((nackcnt &gt; 0) &amp;&amp; (nackcnt &lt; 3));
<a name="l01212"></a>01212   }
<a name="l01213"></a>01213     <span class="keywordflow">return</span> edat64;
<a name="l01214"></a>01214 }
<a name="l01215"></a>01215 <span class="comment"></span>
<a name="l01216"></a>01216 <span class="comment">/** Write EEPROM to slave bypassing cache. FPWR method.</span>
<a name="l01217"></a>01217 <span class="comment"> * @param[in] configadr = configured address of slave</span>
<a name="l01218"></a>01218 <span class="comment"> * @param[in] eeproma   = (WORD) Address in the EEPROM</span>
<a name="l01219"></a>01219 <span class="comment"> * @param[in] data    = 16bit data</span>
<a name="l01220"></a>01220 <span class="comment"> * @param[in] timeout = Timeout in us.</span>
<a name="l01221"></a>01221 <span class="comment"> * @return &gt;0 if OK</span>
<a name="l01222"></a>01222 <span class="comment"> */</span>
<a name="l01223"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#ad4724bcbd8417e56ff2405cec44d6535">01223</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ad4724bcbd8417e56ff2405cec44d6535" title="Write EEPROM to slave bypassing cache.">ec_writeeepromFP</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> eeproma, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> data, <span class="keywordtype">int</span> timeout)
<a name="l01224"></a>01224 {
<a name="l01225"></a>01225     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> estat;
<a name="l01226"></a>01226     <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">ec_eepromt</a> ed;
<a name="l01227"></a>01227   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a>, rval = 0, cnt = 0, nackcnt = 0;
<a name="l01228"></a>01228   <span class="keyword">struct </span>timeval tv1, tv2, tve;
<a name="l01229"></a>01229   
<a name="l01230"></a>01230   gettimeofday(&amp;tv1, 0);
<a name="l01231"></a>01231   tv2.tv_sec = 0;
<a name="l01232"></a>01232   tv2.tv_usec = timeout;
<a name="l01233"></a>01233   timeradd(&amp;tv1, &amp;tv2, &amp;tve);
<a name="l01234"></a>01234   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a683af1ff758441cb62905cb041e428a1">ec_eeprom_waitnotbusyFP</a>(configadr, &amp;estat, timeout))
<a name="l01235"></a>01235   {
<a name="l01236"></a>01236     <span class="keywordflow">if</span> (estat &amp; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ab9419abfbf52a4003015c51b73bb15e2" title="EEprom state machine error flag mask.">EC_ESTAT_EMASK</a>) <span class="comment">/* error bits are set */</span>
<a name="l01237"></a>01237     {
<a name="l01238"></a>01238       estat = htoes(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a2dd0ee42096f9789813a172b15ef8109ae3f82aa9fbf496dc48b0e185e331f1fa" title="No operation.">EC_ECMD_NOP</a>); <span class="comment">/* clear error bits */</span>
<a name="l01239"></a>01239       wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#aa2fe58363a824f15838718ee31f11ffc" title="FPWR &amp;quot;configured address write&amp;quot; primitive.">ec_FPWR</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a36c8c891a4dc0801621d7e65612a38d5">ECT_REG_EEPCTL</a>, <span class="keyword">sizeof</span>(estat), &amp;estat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01240"></a>01240     }
<a name="l01241"></a>01241     <span class="keywordflow">do</span>
<a name="l01242"></a>01242     {
<a name="l01243"></a>01243       cnt = 0;
<a name="l01244"></a>01244       <span class="keywordflow">do</span>
<a name="l01245"></a>01245         wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#aa2fe58363a824f15838718ee31f11ffc" title="FPWR &amp;quot;configured address write&amp;quot; primitive.">ec_FPWR</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a39cb96c8f01f5a283bbb81e2149731dd">ECT_REG_EEPDAT</a>, <span class="keyword">sizeof</span>(data), &amp;data, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01246"></a>01246       <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l01247"></a>01247       ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#a5307909961ad21d67d4c6580552f5bbe">comm</a> = <a class="code" href="../../d2/dbb/ethercattype_8h.html#a2dd0ee42096f9789813a172b15ef8109a8d55b9bde1dcf526efb24ee837aafe68" title="Write.">EC_ECMD_WRITE</a>;
<a name="l01248"></a>01248       ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#acf380647fbea1a0daaa9c8759927c966">addr</a> = eeproma;
<a name="l01249"></a>01249       ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#af0b786050ce4a35f23b36ec4124bcb58">d2</a>   = 0x0000;
<a name="l01250"></a>01250       cnt = 0;
<a name="l01251"></a>01251       <span class="keywordflow">do</span>
<a name="l01252"></a>01252         wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#aa2fe58363a824f15838718ee31f11ffc" title="FPWR &amp;quot;configured address write&amp;quot; primitive.">ec_FPWR</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a36c8c891a4dc0801621d7e65612a38d5">ECT_REG_EEPCTL</a>, <span class="keyword">sizeof</span>(ed), &amp;ed, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01253"></a>01253       <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l01254"></a>01254       <span class="keywordflow">if</span> (wkc)
<a name="l01255"></a>01255       {
<a name="l01256"></a>01256         usleep(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a> * 2);
<a name="l01257"></a>01257         estat = 0x0000;
<a name="l01258"></a>01258         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a683af1ff758441cb62905cb041e428a1">ec_eeprom_waitnotbusyFP</a>(configadr, &amp;estat, timeout))
<a name="l01259"></a>01259         { 
<a name="l01260"></a>01260           <span class="keywordflow">if</span> (estat &amp; <a class="code" href="../../d2/dbb/ethercattype_8h.html#a8386909d61a1353ca45e918ca929416a" title="EEprom state machine error acknowledge.">EC_ESTAT_NACK</a>)
<a name="l01261"></a>01261           {
<a name="l01262"></a>01262             nackcnt++;
<a name="l01263"></a>01263             usleep(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a9aa8dea54bcf04a40e86c127f5751f1d" title="delay in us for eeprom ready loop">EC_LOCALDELAY</a> * 5);
<a name="l01264"></a>01264           }
<a name="l01265"></a>01265           <span class="keywordflow">else</span>
<a name="l01266"></a>01266           {
<a name="l01267"></a>01267             nackcnt = 0;
<a name="l01268"></a>01268             rval = 1;
<a name="l01269"></a>01269           }
<a name="l01270"></a>01270         }
<a name="l01271"></a>01271       }
<a name="l01272"></a>01272     }
<a name="l01273"></a>01273     <span class="keywordflow">while</span> ((nackcnt &gt; 0) &amp;&amp; (nackcnt &lt; 3));   
<a name="l01274"></a>01274   }
<a name="l01275"></a>01275     <span class="keywordflow">return</span> rval;
<a name="l01276"></a>01276 }
<a name="l01277"></a>01277 <span class="comment"></span>
<a name="l01278"></a>01278 <span class="comment">/** Read EEPROM from slave bypassing cache.</span>
<a name="l01279"></a>01279 <span class="comment"> * Parallel read step 1, make request to slave.</span>
<a name="l01280"></a>01280 <span class="comment"> * @param[in] slave   = Slave number</span>
<a name="l01281"></a>01281 <span class="comment"> * @param[in] eeproma   = (WORD) Address in the EEPROM</span>
<a name="l01282"></a>01282 <span class="comment"> */</span>
<a name="l01283"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#ad920436309547d99e23cb8fd7b56b1bc">01283</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#ad920436309547d99e23cb8fd7b56b1bc" title="Read EEPROM from slave bypassing cache.">ec_readeeprom1</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> eeproma)
<a name="l01284"></a>01284 {
<a name="l01285"></a>01285     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> configadr, estat;
<a name="l01286"></a>01286     <a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html" title="SDO structure, not to be confused with EcSDOserviceT.">ec_eepromt</a> ed;
<a name="l01287"></a>01287   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a>, cnt = 0;
<a name="l01288"></a>01288 
<a name="l01289"></a>01289   <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a027bd337ebfa1d39de8a7a1f5c5287de" title="Set eeprom control to master.">ec_eeprom2master</a>(slave); <span class="comment">/* set eeprom control to master */</span>
<a name="l01290"></a>01290     configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>;
<a name="l01291"></a>01291   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a683af1ff758441cb62905cb041e428a1">ec_eeprom_waitnotbusyFP</a>(configadr, &amp;estat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a8684bafce6bd5ae0676fd6440a832276" title="timeout value in us for EEPROM access">EC_TIMEOUTEEP</a>))
<a name="l01292"></a>01292   {
<a name="l01293"></a>01293     <span class="keywordflow">if</span> (estat &amp; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ab9419abfbf52a4003015c51b73bb15e2" title="EEprom state machine error flag mask.">EC_ESTAT_EMASK</a>) <span class="comment">/* error bits are set */</span>
<a name="l01294"></a>01294     {
<a name="l01295"></a>01295       estat = htoes(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a2dd0ee42096f9789813a172b15ef8109ae3f82aa9fbf496dc48b0e185e331f1fa" title="No operation.">EC_ECMD_NOP</a>); <span class="comment">/* clear error bits */</span>
<a name="l01296"></a>01296       wkc=<a class="code" href="../../d5/d74/ethercatbase_8c.html#aa2fe58363a824f15838718ee31f11ffc" title="FPWR &amp;quot;configured address write&amp;quot; primitive.">ec_FPWR</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a36c8c891a4dc0801621d7e65612a38d5">ECT_REG_EEPCTL</a>, <span class="keyword">sizeof</span>(estat), &amp;estat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01297"></a>01297     }
<a name="l01298"></a>01298     ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#a5307909961ad21d67d4c6580552f5bbe">comm</a> = htoes(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a2dd0ee42096f9789813a172b15ef8109a3463bc22acea07dadd859c440ea9c067" title="Read.">EC_ECMD_READ</a>);
<a name="l01299"></a>01299     ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#acf380647fbea1a0daaa9c8759927c966">addr</a> = htoes(eeproma);
<a name="l01300"></a>01300     ed.<a class="code" href="../../df/d6b/struct_p_a_c_k_e_d.html#af0b786050ce4a35f23b36ec4124bcb58">d2</a>   = 0x0000;
<a name="l01301"></a>01301     <span class="keywordflow">do</span>
<a name="l01302"></a>01302       wkc = <a class="code" href="../../d5/d74/ethercatbase_8c.html#aa2fe58363a824f15838718ee31f11ffc" title="FPWR &amp;quot;configured address write&amp;quot; primitive.">ec_FPWR</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a36c8c891a4dc0801621d7e65612a38d5">ECT_REG_EEPCTL</a>, <span class="keyword">sizeof</span>(ed), &amp;ed, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01303"></a>01303     <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l01304"></a>01304   }
<a name="l01305"></a>01305 }
<a name="l01306"></a>01306 <span class="comment"></span>
<a name="l01307"></a>01307 <span class="comment">/** Read EEPROM from slave bypassing cache.</span>
<a name="l01308"></a>01308 <span class="comment"> * Parallel read step 2, actual read from slave.</span>
<a name="l01309"></a>01309 <span class="comment"> * @param[in] slave   = Slave number</span>
<a name="l01310"></a>01310 <span class="comment"> * @param[in] timeout = Timeout in us.</span>
<a name="l01311"></a>01311 <span class="comment"> * @return EEPROM data 32bit</span>
<a name="l01312"></a>01312 <span class="comment"> */</span>
<a name="l01313"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a31e35cc2f33ecf639db43c79850462ab">01313</a> <a class="code" href="../../d2/dbb/ethercattype_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a31e35cc2f33ecf639db43c79850462ab" title="Read EEPROM from slave bypassing cache.">ec_readeeprom2</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="../../d1/da4/eepromtool_8c.html#a7f46665d1fe6d01a75a90942bb34cfaf">slave</a>, <span class="keywordtype">int</span> timeout)
<a name="l01314"></a>01314 {
<a name="l01315"></a>01315     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> estat, configadr;
<a name="l01316"></a>01316     <a class="code" href="../../d2/dbb/ethercattype_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> edat;
<a name="l01317"></a>01317   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a>, cnt = 0;
<a name="l01318"></a>01318   <span class="keyword">struct </span>timeval tv1, tv2, tve;
<a name="l01319"></a>01319   
<a name="l01320"></a>01320   gettimeofday(&amp;tv1, 0);
<a name="l01321"></a>01321   tv2.tv_sec = 0;
<a name="l01322"></a>01322   tv2.tv_usec = timeout;
<a name="l01323"></a>01323   timeradd(&amp;tv1, &amp;tv2, &amp;tve);
<a name="l01324"></a>01324     configadr = ec_slave[slave].<a class="code" href="../../da/dff/structec__slavet.html#aba5576ebc3c34ee46d929c731269cae4" title="Configured address.">configadr</a>;
<a name="l01325"></a>01325   edat = 0;
<a name="l01326"></a>01326     estat = 0x0000;
<a name="l01327"></a>01327   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a683af1ff758441cb62905cb041e428a1">ec_eeprom_waitnotbusyFP</a>(configadr, &amp;estat, timeout))
<a name="l01328"></a>01328   { 
<a name="l01329"></a>01329     <span class="keywordflow">do</span>
<a name="l01330"></a>01330         wkc = <a class="code" href="../../d5/d74/ethercatbase_8c.html#aac2dc2b5a39ace0793473ab89bb56c7d" title="FPRD &amp;quot;configured address read&amp;quot; primitive.">ec_FPRD</a>(configadr, <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a39cb96c8f01f5a283bbb81e2149731dd">ECT_REG_EEPDAT</a>, <span class="keyword">sizeof</span>(edat), &amp;edat, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a334e41422731fd6d427d2a7ec790779c" title="timeout value in us for tx frame to return to rx">EC_TIMEOUTRET</a>);
<a name="l01331"></a>01331     <span class="keywordflow">while</span> ((wkc &lt;= 0) &amp;&amp; (cnt++ &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#ae44ad727dfe650b478e0bd17735756d5" title="default number of retries if wkc &amp;lt;= 0">EC_DEFAULTRETRIES</a>));
<a name="l01332"></a>01332   }
<a name="l01333"></a>01333 
<a name="l01334"></a>01334     <span class="keywordflow">return</span> edat;
<a name="l01335"></a>01335 }
<a name="l01336"></a>01336 <span class="comment"></span>
<a name="l01337"></a>01337 <span class="comment">/** Push index of segmented LRD/LWR/LRW combination.</span>
<a name="l01338"></a>01338 <span class="comment"> * @param[in] idx     = Used datagram index.</span>
<a name="l01339"></a>01339 <span class="comment"> * @param[in] data      = Pointer to process data segment.</span>
<a name="l01340"></a>01340 <span class="comment"> * @param[in] length    = Length of data segment in bytes.</span>
<a name="l01341"></a>01341 <span class="comment"> */</span>
<a name="l01342"></a>01342 <span class="keyword">static</span> <span class="keywordtype">void</span> ec_pushindex(<a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> idx, <span class="keywordtype">void</span> *data, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> length)
<a name="l01343"></a>01343 {
<a name="l01344"></a>01344   <span class="keywordflow">if</span>(ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a3205168dc4671aca28a039b9770765c0">pushed</a> &lt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#a43211ae8db6b984d0afed5c870e2a0bf" title="number of frame buffers per channel (tx, rx1 rx2)">EC_MAXBUF</a>)
<a name="l01345"></a>01345   {
<a name="l01346"></a>01346     ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a6ce8a93c3e54aabe5f17f2b22600971e">idx</a>[ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a3205168dc4671aca28a039b9770765c0">pushed</a>] = idx;
<a name="l01347"></a>01347     ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a20b056ab6fddf6c39d1ea8b8e98f17e8">data</a>[ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a3205168dc4671aca28a039b9770765c0">pushed</a>] = data;
<a name="l01348"></a>01348     ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a342286482b3f5d0978ebd81ce33a0583">length</a>[ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a3205168dc4671aca28a039b9770765c0">pushed</a>] = length;
<a name="l01349"></a>01349     ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a3205168dc4671aca28a039b9770765c0">pushed</a>++;
<a name="l01350"></a>01350   } 
<a name="l01351"></a>01351 } 
<a name="l01352"></a>01352 <span class="comment"></span>
<a name="l01353"></a>01353 <span class="comment">/** Pull index of segmented LRD/LWR/LRW combination.</span>
<a name="l01354"></a>01354 <span class="comment"> * @return Stack location, -1 if stack is empty.</span>
<a name="l01355"></a>01355 <span class="comment"> */</span>
<a name="l01356"></a>01356 <span class="keyword">static</span> <span class="keywordtype">int</span> ec_pullindex(<span class="keywordtype">void</span>)
<a name="l01357"></a>01357 {
<a name="l01358"></a>01358   <span class="keywordtype">int</span> rval = -1;
<a name="l01359"></a>01359   <span class="keywordflow">if</span>(ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#ad1b9826ad7afec8cf7ac4889cf91480f">pulled</a> &lt; ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a3205168dc4671aca28a039b9770765c0">pushed</a>)
<a name="l01360"></a>01360   {
<a name="l01361"></a>01361     rval = ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#ad1b9826ad7afec8cf7ac4889cf91480f">pulled</a>;
<a name="l01362"></a>01362     ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#ad1b9826ad7afec8cf7ac4889cf91480f">pulled</a>++;
<a name="l01363"></a>01363   }
<a name="l01364"></a>01364   
<a name="l01365"></a>01365   <span class="keywordflow">return</span> rval;
<a name="l01366"></a>01366 } 
<a name="l01367"></a>01367 <span class="comment"></span>
<a name="l01368"></a>01368 <span class="comment">/** Transmit processdata to slaves.</span>
<a name="l01369"></a>01369 <span class="comment"> * Uses LRW, or LRD/LWR if LRW is not allowed (blockLRW).</span>
<a name="l01370"></a>01370 <span class="comment"> * Both the input and output processdata are transmitted.</span>
<a name="l01371"></a>01371 <span class="comment"> * The outputs with the actual data, the inputs have a placeholder.</span>
<a name="l01372"></a>01372 <span class="comment"> * The inputs are gathered with the receive processdata function.</span>
<a name="l01373"></a>01373 <span class="comment"> * In contrast to the base LRW function this function is non-blocking.</span>
<a name="l01374"></a>01374 <span class="comment"> * If the processdata does not fit in one datagram, multiple are used.</span>
<a name="l01375"></a>01375 <span class="comment"> * In order to recombine the slave response, a stack is used.</span>
<a name="l01376"></a>01376 <span class="comment"> * @return &gt;0 if processdata is transmitted.</span>
<a name="l01377"></a>01377 <span class="comment"> */</span>
<a name="l01378"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a5e2063e4eb419e7abdcc9d863dc7a7b4">01378</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a5e2063e4eb419e7abdcc9d863dc7a7b4" title="Transmit processdata to slaves.">ec_send_processdata_group</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> group)
<a name="l01379"></a>01379 {
<a name="l01380"></a>01380   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> LogAdr;
<a name="l01381"></a>01381   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> w1, w2;
<a name="l01382"></a>01382   <span class="keywordtype">int</span> length, sublength;
<a name="l01383"></a>01383     <a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> idx;
<a name="l01384"></a>01384   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a>;
<a name="l01385"></a>01385   <span class="keywordtype">void</span>* data;
<a name="l01386"></a>01386   <span class="keywordtype">boolean</span> first=<a class="code" href="../../d2/dbb/ethercattype_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01387"></a>01387   <a class="code" href="../../d2/dbb/ethercattype_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> currentsegment = 0;
<a name="l01388"></a>01388 
<a name="l01389"></a>01389   wkc = 0;
<a name="l01390"></a>01390   <span class="keywordflow">if</span>(ec_group[group].hasdc)
<a name="l01391"></a>01391     first = <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01392"></a>01392   length = ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#aa4793d235fa626746b8260e94e48287b" title="output bytes, if Obits &amp;lt; 8 then Obytes = 0">Obytes</a> + ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#a4057eeb48537a3d8c6472e58ef2af257" title="input bytes, if Ibits &amp;lt; 8 then Ibytes = 0">Ibytes</a>;
<a name="l01393"></a>01393   LogAdr = ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#a7b832620a65130fdc17cf6a151410bd9" title="logical start address for this group">logstartaddr</a>;
<a name="l01394"></a>01394   <span class="keywordflow">if</span> (length)
<a name="l01395"></a>01395   { 
<a name="l01396"></a>01396     <span class="keywordflow">if</span>(!group)
<a name="l01397"></a>01397     {
<a name="l01398"></a>01398       ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a3205168dc4671aca28a039b9770765c0">pushed</a> = 0;
<a name="l01399"></a>01399       ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#ad1b9826ad7afec8cf7ac4889cf91480f">pulled</a> = 0;
<a name="l01400"></a>01400     }
<a name="l01401"></a>01401     wkc = 1;
<a name="l01402"></a>01402     <span class="comment">/* LRW blocked by one or more slaves ? */</span>
<a name="l01403"></a>01403     <span class="keywordflow">if</span> (ec_group[group].blockLRW)
<a name="l01404"></a>01404     {
<a name="l01405"></a>01405       <span class="comment">/* if inputs available generate LRD */</span>
<a name="l01406"></a>01406       <span class="keywordflow">if</span>(ec_group[group].Ibytes)
<a name="l01407"></a>01407       {
<a name="l01408"></a>01408         currentsegment = ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#ac208b1c6b1da42117364b4a06f3686b0" title="1st input segment">Isegment</a>;
<a name="l01409"></a>01409         data=ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#a7a99661951b97a06c5050083e25dc105" title="input pointer in IOmap buffer">inputs</a>;
<a name="l01410"></a>01410         length = ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#a4057eeb48537a3d8c6472e58ef2af257" title="input bytes, if Ibits &amp;lt; 8 then Ibytes = 0">Ibytes</a>;
<a name="l01411"></a>01411         LogAdr += ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#aa4793d235fa626746b8260e94e48287b" title="output bytes, if Obits &amp;lt; 8 then Obytes = 0">Obytes</a>;
<a name="l01412"></a>01412         <span class="comment">/* segment transfer if needed */</span>
<a name="l01413"></a>01413         <span class="keywordflow">do</span>
<a name="l01414"></a>01414         {     
<a name="l01415"></a>01415           <span class="keywordflow">if</span>(currentsegment == ec_group[group].Isegment)
<a name="l01416"></a>01416             sublength = ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#acc860f5b26d9b558fcf44b8e8199f913" title="IO segmentation list.">IOsegment</a>[currentsegment++] - ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#a16ff855d59206457e8340ec8a7ed4ed0" title="Offset in input segment.">Ioffset</a>;
<a name="l01417"></a>01417           <span class="keywordflow">else</span>
<a name="l01418"></a>01418             sublength = ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#acc860f5b26d9b558fcf44b8e8199f913" title="IO segmentation list.">IOsegment</a>[currentsegment++];
<a name="l01419"></a>01419           <span class="comment">/* get new index */</span>
<a name="l01420"></a>01420             idx = <a class="code" href="../../dc/d9b/nicdrv_8c.html#ae3520c51670d8e4e3e360f26fd8acee4" title="Get new frame identifier index and allocate corresponding rx buffer.">ec_getindex</a>();
<a name="l01421"></a>01421           w1 = <a class="code" href="../../d2/dbb/ethercattype_8h.html#a639896c5e20b5ef7bff9b35bf1637dd0" title="Macro to get hi word of a dword.">LO_WORD</a>(LogAdr);
<a name="l01422"></a>01422           w2 = <a class="code" href="../../d2/dbb/ethercattype_8h.html#a1b97e31e27113ee96f5d004497c81e7d" title="Macro to get hi word of a dword.">HI_WORD</a>(LogAdr);
<a name="l01423"></a>01423             <a class="code" href="../../d5/d74/ethercatbase_8c.html#a3b9a1e2b9fc1e15cf147a85d484db027" title="Generate and set EtherCAT datagram in a standard ethernet frame.">ec_setupdatagram</a>(&amp;<a class="code" href="../../dc/d9b/nicdrv_8c.html#ad4c92ed6fc9b6c95768da08f36cbc14d" title="transmit buffers">ec_txbuf</a>[idx], <a class="code" href="../../d2/dbb/ethercattype_8h.html#ab7e74d81c2756929a05440f98f34b41ba152f215000fd8e9421f504b97519202b" title="Logical Memory Read.">EC_CMD_LRD</a>, idx, w1, w2, sublength, data);
<a name="l01424"></a>01424           <span class="comment">/* send frame */</span>
<a name="l01425"></a>01425           <a class="code" href="../../dc/d9b/nicdrv_8c.html#afb39cbe067b1afa202e8c487a33c4d66" title="Transmit buffer over socket (non blocking).">ec_outframe_red</a>(idx);
<a name="l01426"></a>01426           <span class="comment">/* push index and data pointer on stack */</span>
<a name="l01427"></a>01427           ec_pushindex(idx, data, sublength);
<a name="l01428"></a>01428           length -= sublength;
<a name="l01429"></a>01429           LogAdr += sublength;
<a name="l01430"></a>01430           data += sublength;
<a name="l01431"></a>01431         } <span class="keywordflow">while</span> (length &amp;&amp; (currentsegment &lt; ec_group[group].nsegments)); 
<a name="l01432"></a>01432       } 
<a name="l01433"></a>01433       <span class="comment">/* if outputs available generate LWR */</span>
<a name="l01434"></a>01434       <span class="keywordflow">if</span>(ec_group[group].Obytes)
<a name="l01435"></a>01435       {
<a name="l01436"></a>01436         data=ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#a601a0f0ed2760c8c633dbaf4eef460ed" title="output pointer in IOmap buffer">outputs</a>;
<a name="l01437"></a>01437         length = ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#aa4793d235fa626746b8260e94e48287b" title="output bytes, if Obits &amp;lt; 8 then Obytes = 0">Obytes</a>;
<a name="l01438"></a>01438         LogAdr = ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#a7b832620a65130fdc17cf6a151410bd9" title="logical start address for this group">logstartaddr</a>;
<a name="l01439"></a>01439         currentsegment = 0;
<a name="l01440"></a>01440         <span class="comment">/* segment transfer if needed */</span>
<a name="l01441"></a>01441         <span class="keywordflow">do</span>
<a name="l01442"></a>01442         {     
<a name="l01443"></a>01443           sublength = ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#acc860f5b26d9b558fcf44b8e8199f913" title="IO segmentation list.">IOsegment</a>[currentsegment++];
<a name="l01444"></a>01444           <span class="keywordflow">if</span>((length - sublength) &lt; 0)
<a name="l01445"></a>01445             sublength = length;
<a name="l01446"></a>01446           <span class="comment">/* get new index */</span>
<a name="l01447"></a>01447             idx = <a class="code" href="../../dc/d9b/nicdrv_8c.html#ae3520c51670d8e4e3e360f26fd8acee4" title="Get new frame identifier index and allocate corresponding rx buffer.">ec_getindex</a>();
<a name="l01448"></a>01448           w1 = <a class="code" href="../../d2/dbb/ethercattype_8h.html#a639896c5e20b5ef7bff9b35bf1637dd0" title="Macro to get hi word of a dword.">LO_WORD</a>(LogAdr);
<a name="l01449"></a>01449           w2 = <a class="code" href="../../d2/dbb/ethercattype_8h.html#a1b97e31e27113ee96f5d004497c81e7d" title="Macro to get hi word of a dword.">HI_WORD</a>(LogAdr);
<a name="l01450"></a>01450             <a class="code" href="../../d5/d74/ethercatbase_8c.html#a3b9a1e2b9fc1e15cf147a85d484db027" title="Generate and set EtherCAT datagram in a standard ethernet frame.">ec_setupdatagram</a>(&amp;<a class="code" href="../../dc/d9b/nicdrv_8c.html#ad4c92ed6fc9b6c95768da08f36cbc14d" title="transmit buffers">ec_txbuf</a>[idx], <a class="code" href="../../d2/dbb/ethercattype_8h.html#ab7e74d81c2756929a05440f98f34b41baa9c4579ad968bcae9fa23293e6f27110" title="Logical Memory Write.">EC_CMD_LWR</a>, idx, w1, w2, sublength, data);
<a name="l01451"></a>01451           <span class="comment">/* send frame */</span>
<a name="l01452"></a>01452           <a class="code" href="../../dc/d9b/nicdrv_8c.html#afb39cbe067b1afa202e8c487a33c4d66" title="Transmit buffer over socket (non blocking).">ec_outframe_red</a>(idx);
<a name="l01453"></a>01453           <span class="comment">/* push index and data pointer on stack */</span>
<a name="l01454"></a>01454           ec_pushindex(idx, data, sublength);
<a name="l01455"></a>01455           length -= sublength;
<a name="l01456"></a>01456           LogAdr += sublength;
<a name="l01457"></a>01457           data += sublength;
<a name="l01458"></a>01458         } <span class="keywordflow">while</span> (length &amp;&amp; (currentsegment &lt; ec_group[group].nsegments)); 
<a name="l01459"></a>01459       }
<a name="l01460"></a>01460     }
<a name="l01461"></a>01461     <span class="comment">/* LRW can be used */</span>
<a name="l01462"></a>01462     <span class="keywordflow">else</span>
<a name="l01463"></a>01463     { 
<a name="l01464"></a>01464       <span class="keywordflow">if</span> (ec_group[group].Obytes)
<a name="l01465"></a>01465         data=ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#a601a0f0ed2760c8c633dbaf4eef460ed" title="output pointer in IOmap buffer">outputs</a>;
<a name="l01466"></a>01466       <span class="keywordflow">else</span>
<a name="l01467"></a>01467         data=ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#a7a99661951b97a06c5050083e25dc105" title="input pointer in IOmap buffer">inputs</a>;
<a name="l01468"></a>01468       <span class="comment">/* segment transfer if needed */</span>
<a name="l01469"></a>01469       <span class="keywordflow">do</span>
<a name="l01470"></a>01470       {     
<a name="l01471"></a>01471         sublength = ec_group[group].<a class="code" href="../../dd/d43/structec__groupt.html#acc860f5b26d9b558fcf44b8e8199f913" title="IO segmentation list.">IOsegment</a>[currentsegment++];
<a name="l01472"></a>01472         <span class="comment">/* get new index */</span>
<a name="l01473"></a>01473           idx = <a class="code" href="../../dc/d9b/nicdrv_8c.html#ae3520c51670d8e4e3e360f26fd8acee4" title="Get new frame identifier index and allocate corresponding rx buffer.">ec_getindex</a>();
<a name="l01474"></a>01474           w1 = <a class="code" href="../../d2/dbb/ethercattype_8h.html#a639896c5e20b5ef7bff9b35bf1637dd0" title="Macro to get hi word of a dword.">LO_WORD</a>(LogAdr);
<a name="l01475"></a>01475         w2 = <a class="code" href="../../d2/dbb/ethercattype_8h.html#a1b97e31e27113ee96f5d004497c81e7d" title="Macro to get hi word of a dword.">HI_WORD</a>(LogAdr);
<a name="l01476"></a>01476           <a class="code" href="../../d5/d74/ethercatbase_8c.html#a3b9a1e2b9fc1e15cf147a85d484db027" title="Generate and set EtherCAT datagram in a standard ethernet frame.">ec_setupdatagram</a>(&amp;<a class="code" href="../../dc/d9b/nicdrv_8c.html#ad4c92ed6fc9b6c95768da08f36cbc14d" title="transmit buffers">ec_txbuf</a>[idx], <a class="code" href="../../d2/dbb/ethercattype_8h.html#ab7e74d81c2756929a05440f98f34b41ba8bda13cb2903b0559c3ebf7dbc89fa58" title="Logical Memory Read Write.">EC_CMD_LRW</a>, idx, w1, w2, sublength, data);
<a name="l01477"></a>01477         <span class="keywordflow">if</span>(first)
<a name="l01478"></a>01478         {
<a name="l01479"></a>01479           ec_DCl = sublength;
<a name="l01480"></a>01480           <span class="comment">/* FPRMW in second datagram */</span>
<a name="l01481"></a>01481             <a class="code" href="../../d3/d6b/ethercatmain_8c.html#aa8af54f31728e900657522c71b0f4fb9">ec_DCtO</a> = <a class="code" href="../../d5/d74/ethercatbase_8c.html#a775297e7bcfe08569ad537d6e3a770fb" title="Add EtherCAT datagram to a standard ethernet frame with existing datagram(s).">ec_adddatagram</a>(&amp;<a class="code" href="../../dc/d9b/nicdrv_8c.html#ad4c92ed6fc9b6c95768da08f36cbc14d" title="transmit buffers">ec_txbuf</a>[idx], <a class="code" href="../../d2/dbb/ethercattype_8h.html#ab7e74d81c2756929a05440f98f34b41ba21b5a9367f89fcb81acd50c447004a61" title="Configured Read Mulitple Write.">EC_CMD_FRMW</a>, idx, <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, 
<a name="l01482"></a>01482                        ec_slave[ec_group[group].DCnext].configadr, 
<a name="l01483"></a>01483                        <a class="code" href="../../d2/dbb/ethercattype_8h.html#adb49720dc49f7d4e4cf9adbf2948e409a4d674a60a50587c638f1acaa6d92a1ba">ECT_REG_DCSYSTIME</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a4774df1c543d7a4941bc96af7d0fd9b8">ec_DCtime</a>), &amp;<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a4774df1c543d7a4941bc96af7d0fd9b8">ec_DCtime</a>);
<a name="l01484"></a>01484           first = <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01485"></a>01485         }         
<a name="l01486"></a>01486         <span class="comment">/* send frame */</span>
<a name="l01487"></a>01487         <a class="code" href="../../dc/d9b/nicdrv_8c.html#afb39cbe067b1afa202e8c487a33c4d66" title="Transmit buffer over socket (non blocking).">ec_outframe_red</a>(idx);
<a name="l01488"></a>01488         <span class="comment">/* push index and data pointer on stack */</span>
<a name="l01489"></a>01489         ec_pushindex(idx, data, sublength);
<a name="l01490"></a>01490         length -= sublength;
<a name="l01491"></a>01491         LogAdr += sublength;
<a name="l01492"></a>01492         data += sublength;
<a name="l01493"></a>01493       } <span class="keywordflow">while</span> (length &amp;&amp; (currentsegment &lt; ec_group[group].nsegments)); 
<a name="l01494"></a>01494     } 
<a name="l01495"></a>01495   } 
<a name="l01496"></a>01496 
<a name="l01497"></a>01497   <span class="keywordflow">return</span> wkc;
<a name="l01498"></a>01498 }
<a name="l01499"></a>01499 <span class="comment"></span>
<a name="l01500"></a>01500 <span class="comment">/** Receive processdata from slaves.</span>
<a name="l01501"></a>01501 <span class="comment"> * Second part from ec_send_processdata().</span>
<a name="l01502"></a>01502 <span class="comment"> * Received datagrams are recombined with the processdata with help from the stack.</span>
<a name="l01503"></a>01503 <span class="comment"> * If a datagram contains input processdata it copies it to the processdata structure.</span>
<a name="l01504"></a>01504 <span class="comment"> * @param[in] timeout   = Timeout in us.</span>
<a name="l01505"></a>01505 <span class="comment"> * @return Work counter.</span>
<a name="l01506"></a>01506 <span class="comment"> */</span>
<a name="l01507"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a974363168ed4259d2d5a48a9e7317354">01507</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a974363168ed4259d2d5a48a9e7317354" title="Receive processdata from slaves.">ec_receive_processdata_group</a>(<a class="code" href="../../d2/dbb/ethercattype_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> group, <span class="keywordtype">int</span> timeout)
<a name="l01508"></a>01508 {
<a name="l01509"></a>01509     <span class="keywordtype">int</span> pos, idx;
<a name="l01510"></a>01510   <span class="keywordtype">int</span> <a class="code" href="../../d1/da4/eepromtool_8c.html#aa59bf150c9e0d285619f7c7e58c9942d">wkc</a> = 0, wkc2;
<a name="l01511"></a>01511   <span class="keywordtype">boolean</span> first = <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01512"></a>01512 
<a name="l01513"></a>01513   <span class="keywordflow">if</span>(ec_group[group].hasdc)
<a name="l01514"></a>01514     first = <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01515"></a>01515   <span class="comment">/* get first index */</span>
<a name="l01516"></a>01516   pos = ec_pullindex();
<a name="l01517"></a>01517   <span class="comment">/* read the same number of frames as send */</span>
<a name="l01518"></a>01518   <span class="keywordflow">while</span> (pos &gt;= 0)
<a name="l01519"></a>01519   { 
<a name="l01520"></a>01520     idx = ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a6ce8a93c3e54aabe5f17f2b22600971e">idx</a>[pos];
<a name="l01521"></a>01521       wkc2 = <a class="code" href="../../dc/d9b/nicdrv_8c.html#a3bcbccf53a33907e16fa67c8e5b45d40" title="Blocking receive frame function.">ec_waitinframe</a>(ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a6ce8a93c3e54aabe5f17f2b22600971e">idx</a>[pos], timeout);
<a name="l01522"></a>01522     <span class="comment">/* check if there is input data in frame */</span>
<a name="l01523"></a>01523     <span class="keywordflow">if</span> ((wkc2 &gt; <a class="code" href="../../d2/dbb/ethercattype_8h.html#a908d89d42b92f87ea30a2c34c7de2307" title="return value no frame returned">EC_NOFRAME</a>) &amp;&amp; ((<a class="code" href="../../dc/d9b/nicdrv_8c.html#aee8e5ba09644b6afe45d29196bb35684" title="primary rx buffers">ec_rxbuf</a>[idx][<a class="code" href="../../d2/dbb/ethercattype_8h.html#ab59e47a877d86e7b536065ff5fd7a0c1" title="offset position of command in EtherCAT header">EC_CMDOFFSET</a>]==<a class="code" href="../../d2/dbb/ethercattype_8h.html#ab7e74d81c2756929a05440f98f34b41ba152f215000fd8e9421f504b97519202b" title="Logical Memory Read.">EC_CMD_LRD</a>) || (<a class="code" href="../../dc/d9b/nicdrv_8c.html#aee8e5ba09644b6afe45d29196bb35684" title="primary rx buffers">ec_rxbuf</a>[idx][<a class="code" href="../../d2/dbb/ethercattype_8h.html#ab59e47a877d86e7b536065ff5fd7a0c1" title="offset position of command in EtherCAT header">EC_CMDOFFSET</a>]==<a class="code" href="../../d2/dbb/ethercattype_8h.html#ab7e74d81c2756929a05440f98f34b41ba8bda13cb2903b0559c3ebf7dbc89fa58" title="Logical Memory Read Write.">EC_CMD_LRW</a>)))
<a name="l01524"></a>01524       {
<a name="l01525"></a>01525       <span class="keywordflow">if</span>(first)
<a name="l01526"></a>01526       { 
<a name="l01527"></a>01527             memcpy(ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a20b056ab6fddf6c39d1ea8b8e98f17e8">data</a>[pos], &amp;<a class="code" href="../../dc/d9b/nicdrv_8c.html#aee8e5ba09644b6afe45d29196bb35684" title="primary rx buffers">ec_rxbuf</a>[idx][<a class="code" href="../../d2/dbb/ethercattype_8h.html#abfad83b47bc51994b6e0cdbdd9a6ce64" title="EtherCAT header size.">EC_HEADERSIZE</a>], ec_DCl);
<a name="l01528"></a>01528         memcpy(&amp;wkc, &amp;<a class="code" href="../../dc/d9b/nicdrv_8c.html#aee8e5ba09644b6afe45d29196bb35684" title="primary rx buffers">ec_rxbuf</a>[idx][EC_HEADERSIZE + ec_DCl], <a class="code" href="../../d2/dbb/ethercattype_8h.html#a46635ccc69dfc2bf090896f684ad98bc" title="size of workcounter item in EtherCAT datagram">EC_WKCSIZE</a>);
<a name="l01529"></a>01529         wkc = etohs(wkc);
<a name="l01530"></a>01530         memcpy(&amp;<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a4774df1c543d7a4941bc96af7d0fd9b8">ec_DCtime</a>, &amp;<a class="code" href="../../dc/d9b/nicdrv_8c.html#aee8e5ba09644b6afe45d29196bb35684" title="primary rx buffers">ec_rxbuf</a>[idx][<a class="code" href="../../d3/d6b/ethercatmain_8c.html#aa8af54f31728e900657522c71b0f4fb9">ec_DCtO</a>], <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a4774df1c543d7a4941bc96af7d0fd9b8">ec_DCtime</a>));
<a name="l01531"></a>01531         <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a4774df1c543d7a4941bc96af7d0fd9b8">ec_DCtime</a> = etohll(<a class="code" href="../../d3/d6b/ethercatmain_8c.html#a4774df1c543d7a4941bc96af7d0fd9b8">ec_DCtime</a>);
<a name="l01532"></a>01532         first = <a class="code" href="../../d2/dbb/ethercattype_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01533"></a>01533       }
<a name="l01534"></a>01534       <span class="keywordflow">else</span>
<a name="l01535"></a>01535       { 
<a name="l01536"></a>01536         <span class="comment">/* copy input data back to process data buffer */</span>
<a name="l01537"></a>01537           memcpy(ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a20b056ab6fddf6c39d1ea8b8e98f17e8">data</a>[pos], &amp;<a class="code" href="../../dc/d9b/nicdrv_8c.html#aee8e5ba09644b6afe45d29196bb35684" title="primary rx buffers">ec_rxbuf</a>[idx][<a class="code" href="../../d2/dbb/ethercattype_8h.html#abfad83b47bc51994b6e0cdbdd9a6ce64" title="EtherCAT header size.">EC_HEADERSIZE</a>], ec_idxstack.<a class="code" href="../../d7/da6/structec__idxstack_t.html#a342286482b3f5d0978ebd81ce33a0583">length</a>[pos]);
<a name="l01538"></a>01538         wkc += wkc2;
<a name="l01539"></a>01539       } 
<a name="l01540"></a>01540       }
<a name="l01541"></a>01541     <span class="comment">/* release buffer */</span>
<a name="l01542"></a>01542       <a class="code" href="../../dc/d9b/nicdrv_8c.html#a121be26fdb9da9ef5b9f217fdcd2d50f" title="Set rx buffer status.">ec_setbufstat</a>(idx, <a class="code" href="../../d2/dbb/ethercattype_8h.html#a67957077f50e57782cc3d0ead7ab47c6a1d3f8e51c7e6df2048c3373dfea95226" title="Empty.">EC_BUF_EMPTY</a>);
<a name="l01543"></a>01543     <span class="comment">/* get next index */</span>
<a name="l01544"></a>01544     pos = ec_pullindex();
<a name="l01545"></a>01545   } 
<a name="l01546"></a>01546 
<a name="l01547"></a>01547   <span class="keywordflow">return</span> wkc;
<a name="l01548"></a>01548 } 
<a name="l01549"></a>01549 
<a name="l01550"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a30c66bb9d54e741149f7d40bbdb21078">01550</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a30c66bb9d54e741149f7d40bbdb21078">ec_send_processdata</a>(<span class="keywordtype">void</span>)
<a name="l01551"></a>01551 {
<a name="l01552"></a>01552   <span class="keywordflow">return</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a5e2063e4eb419e7abdcc9d863dc7a7b4" title="Transmit processdata to slaves.">ec_send_processdata_group</a>(0);
<a name="l01553"></a>01553 }
<a name="l01554"></a>01554 
<a name="l01555"></a><a class="code" href="../../d8/d38/ethercatmain_8h.html#a14280050ace4427d196acd17e6d79e55">01555</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a14280050ace4427d196acd17e6d79e55">ec_receive_processdata</a>(<span class="keywordtype">int</span> timeout)
<a name="l01556"></a>01556 {
<a name="l01557"></a>01557   <span class="keywordflow">return</span> <a class="code" href="../../d3/d6b/ethercatmain_8c.html#a974363168ed4259d2d5a48a9e7317354" title="Receive processdata from slaves.">ec_receive_processdata_group</a>(0, timeout);
<a name="l01558"></a>01558 }
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
